<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IMNUFIT - Portal del Paciente</title>
    
    <!-- PWA / APP MODE CONFIGURATION -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IMNUFIT">
    <meta name="theme-color" content="#FBFBFC">
    
    <!-- ICONO DE PANTALLA DE INICIO -->
    <link rel="apple-touch-icon" href="https://imnufit.com/wp-content/uploads/2025/05/icono_web_512x512.png">
    <link rel="icon" type="image/png" href="https://imnufit.com/wp-content/uploads/2025/05/icono_web_512x512.png">
    <link rel="shortcut icon" href="https://imnufit.com/wp-content/uploads/2025/05/icono_web_512x512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, updatePassword, sendPasswordResetEmail, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. INYECCI√ìN DE MANIFIESTO PWA (AYUDA A CHROME A DETECTAR LA APP) ---
        const manifest = {
            "name": "IMNUFIT Portal",
            "short_name": "IMNUFIT",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#FBFBFC",
            "theme_color": "#FBFBFC",
            "icons": [{
                "src": "https://imnufit.com/wp-content/uploads/2025/05/icono_web_512x512.png",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = URL.createObjectURL(blob);
        document.head.appendChild(link);

        // --- 1. CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJBf7TbP1GuAoA3GsrCG0EJOifEt4YodY",
            authDomain: "imnufit-cad14.firebaseapp.com",
            projectId: "imnufit-cad14",
            storageBucket: "imnufit-cad14.firebasestorage.app",
            messagingSenderId: "65610345018",
            appId: "1:65610345018:web:eac15a30c72084faac6303"
        };

        const AIRTABLE_PAT = "patZ9QUQVyldn9zKC.afb4fc362eb2f79b1aa10faf3fb3268ea6bca3f57a1362b83f6cc8459a50f0d3"; 
        const AIRTABLE_BASE_ID = "appCHcm7XPzeoyBCs"; 
        const AIRTABLE_TABLE_NAME = "Pacientes"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'imnufit-official';

        const _partA = "AIzaSyCPDuual8XB";
        const _partB = "ejuVUPbKecfonbIh6SNolDk";
        const apiKey = _partA + _partB;

        // Variables Globales
        const SPECIALIST_EMAIL = "imnufit@gmail.com";
        let isSpecialistMode = false;
        let specModeSelection = "sin_programa";
        let aiCustomInstructions = ""; 
        let cachedAirtableData = null;
        let currentAppData = null; 
        let chatHistory = [];
        let notificationTimer = null;
        let inactivityTimeout;
        const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10 Minutos

        const CALENDAR_LINK_DEFAULT = "https://calendar.app.google/CE4KjKxPeFiV93GV7";
        const PLANES_LINK = "https://imnufit.com/planes-y-precios/";
        const WHATSAPP_COMMUNITY_LINK = "https://chat.whatsapp.com/FNoToJXy8HO7iLVhPseQHB";

        const PROGRAMAS_INFO = {
            "Adi√≥s Diabetes 2": {
                img: "https://imnufit.com/wp-content/uploads/2024/04/Imagen-de-WhatsApp-2024-04-30-a-las-18.35.48_16bb1ed2.jpg",
                imgWidth: "w-48 md:w-56",
                meses: {
                    1: [{ label: "Gu√≠a Nutricional - Mes 1", desc: "Desintoxicaci√≥n", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-1-Nueva-Edicion.pdf", type: "PDF" }],
                    2: [{ label: "Gu√≠a Nutricional - Mes 2", desc: "Control Gluc√©mico", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-2-Nueva-Edicion.pdf", type: "PDF" }],
                    3: [{ label: "Gu√≠a Nutricional - Mes 3", desc: "Mantenimiento", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-3-Nueva-Edicion.pdf", type: "PDF" }]
                }
            },
            "Quema Grasa": {
                img: "https://imnufit.com/wp-content/uploads/2022/04/qg.png",
                imgWidth: "w-36 md:w-40",
                monthTitles: { 1: "MES 1 - DEPURACI√ìN", 2: "MES 2 - SACIEDAD", 3: "MES 3 - AYUNO INICIAL", 4: "MES 4 - AYUNO 16-18" },
                meses: {
                    1: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Eliminar comestibles da√±inos.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-1-Completo-Depuracion.pdf", type: "PDF" },
                        { label: "Video Explicativo", desc: "Res√∫men del mes.", url: "https://youtu.be/iO5ihFR8Vrg", type: "VIDEO" }
                    ],
                    2: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Nutrici√≥n densa.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-2-Completo-Saciedad.pdf", type: "PDF" },
                        { label: "Video Explicativo", desc: "Res√∫men del mes.", url: "https://youtu.be/AeIQAgoc0Fc", type: "VIDEO" }
                    ],
                    3: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Ayuno natural.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-3-Completo-Ayuno-Inicial.pdf", type: "PDF" },
                        { label: "Video Explicativo", desc: "Res√∫men del mes.", url: "https://youtu.be/CTevX300uG8", type: "VIDEO" }
                    ],
                    4: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Ayuno prolongado.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-4-Completo-Ayuno16-18.pdf", type: "PDF" },
                        { label: "Video Explicativo", desc: "Res√∫men del mes.", url: "https://youtu.be/15VyQaKcOU4", type: "VIDEO" }
                    ]
                }
            },
            "SANO": { 
                img: "https://imnufit.com/wp-content/uploads/2023/11/Sano-logo-1-e1755541161822.png", 
                imgWidth: "w-32 md:w-36",
                meses: {
                    1: [{ label: "Manual SANO - Mes 1", desc: "Alimentaci√≥n Consciente", url: "https://imnufit.com/wp-content/uploads/2023/12/SANO-MES-1.pdf", type: "PDF" }],
                    2: [{ label: "Manual SANO - Mes 2", desc: "Nuevos H√°bitos", url: "https://imnufit.com/wp-content/uploads/2024/02/SANO-Mes-2.pdf", type: "PDF" }]
                }
            }
        };

        const frasesCreyentes = [
            "Todo lo puedo en Cristo que me fortalece.", "Su amor es constante y nuevo cada ma√±ana.", "El Se√±or es mi pastor, nada me faltar√°.",
            "Jehov√° es mi fortaleza y mi escudo.", "Conf√≠a en el Se√±or de todo coraz√≥n.", "Mira que te mando que te esfuerces y seas valiente."
        ];

        // --- 2. FUNCIONES DE UTILIDAD (DECLARADAS AL INICIO) ---
        window.safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
        window.safeUpdate = (id, fn) => { const el = document.getElementById(id); if (el) fn(el); };

        window.notify = (msg, type = 'error') => {
            const t = document.getElementById('notification-toast');
            const c = document.getElementById('notification-content');
            if (t && c) {
                if (notificationTimer) clearTimeout(notificationTimer);
                c.innerHTML = msg;
                const colorClass = type === 'success' ? 'text-emerald-600 border-emerald-100' : 'text-red-600 border-red-100';
                t.className = `fixed top-8 left-1/2 -translate-x-1/2 z-[9999] px-8 py-4 rounded-full shadow-2xl text-[13px] font-semibold bg-white border transform transition-all duration-300 ${colorClass}`;
                t.classList.remove('hidden', 'opacity-0', '-translate-y-10');
                t.classList.add('flex', 'opacity-100', 'translate-y-0');
                notificationTimer = setTimeout(() => {
                    t.classList.remove('opacity-100', 'translate-y-0');
                    t.classList.add('opacity-0', '-translate-y-10');
                    setTimeout(() => { t.classList.add('hidden'); t.classList.remove('flex'); }, 300);
                }, 5000);
            } else { alert(msg); }
        };

        window.resetInactivityTimer = () => {
            if (!auth.currentUser) return;
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                window.notify("Sesi√≥n cerrada por inactividad", "error");
                window.cerrarSesion();
            }, INACTIVITY_LIMIT);
        };

        ['mousemove', 'mousedown', 'click', 'scroll', 'keypress', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, window.resetInactivityTimer, { passive: true });
        });

        window.showView = (id, save = true) => {
            const views = ['login-view', 'signup-view', 'patient-view', 'membership-view', 'program-detail-view', 'forgot-password-view', 'contact-view', 'mobile-ai-view'];
            views.forEach(v => { const el = document.getElementById(v); if (el) el.classList.toggle('hidden', v !== id); });
            window.scrollTo(0, 0);
            if (save) history.pushState({ viewId: id }, "", "");
        };

        window.resetUI = () => {
            cachedAirtableData = null; currentAppData = null; chatHistory = []; isSpecialistMode = false;
            window.safeSetText('display-nombre', "..."); window.safeSetText('display-estatus', "...");
            window.safeSetText('display-frase', "..."); window.safeSetText('plan-banner-title', "...");
            window.safeSetText('acc-nombre', "..."); window.safeSetText('acc-email', "--");
            window.safeSetText('acc-pais', "--"); window.safeSetText('acc-telefono', "--"); window.safeSetText('acc-nacimiento', "--");
            document.getElementById('specialist-panel')?.classList.add('hidden');
            document.getElementById('featured-plan-banner')?.classList.add('hidden');
            document.getElementById('restricted-banner')?.classList.add('hidden');
            document.getElementById('card-ai')?.classList.remove('hidden'); 
            window.clearChat();
            ['card-entrenamientos', 'card-reporte', 'card-citas', 'card-consultas', 'card-community', 'card-install-app-main'].forEach(id => { 
                document.getElementById(id)?.classList.add('hidden'); 
            });
            clearTimeout(inactivityTimeout);
        };

        window.formatDateMDY = (dateString) => {
            if (!dateString) return "--";
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; 
            return `${String(date.getUTCMonth() + 1).padStart(2, '0')}/${String(date.getUTCDate()).padStart(2, '0')}/${date.getUTCFullYear()}`;
        };

        window.getGreeting = () => {
            const h = new Date().getHours();
            if (h >= 6 && h < 12) return { text: "Buenos d√≠as", icon: "‚òÄÔ∏è" };
            if (h >= 12 && h < 18) return { text: "Buenas tardes", icon: "‚òÄÔ∏è" };
            return { text: "Buenas noches", icon: "üåô" };
        };

        window.getStatusClass = (s) => {
            if (!s) return "bg-slate-50 text-slate-400 border-slate-100";
            const sl = String(s).toLowerCase();
            if (sl.includes("inactivo")) return "bg-rose-50 text-red-600 border-rose-200";
            if (sl.includes("activo") || sl.includes("act√≠vo")) return "bg-emerald-50 text-emerald-600 border-emerald-100";
            return "bg-amber-50 text-amber-600 border-amber-100";
        };

        window.getProgramKey = (p) => {
            if (!p) return null;
            const pl = p.toLowerCase();
            if (pl.includes("quema grasa")) return "Quema Grasa";
            if (pl.includes("sano")) return "SANO";
            if (pl.includes("adi√≥s diabetes 2") || pl.includes("adios diabetes 2")) return "Adi√≥s Diabetes 2";
            return null;
        };

        window.parseAIResponse = (text) => {
            if (!text) return "";
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900">$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em class="italic text-slate-600">$1</em>');
            html = html.replace(/\[([^\]]+)\]\(function:([a-zA-Z0-9-]+)\)/g, `<button type="button" onclick="window.handleAIAction('$2')" class="mt-3 flex items-center gap-2 bg-[#2E4982]/10 text-[#2E4982] px-5 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-[#2E4982] hover:text-white transition-all shadow-sm w-full md:w-auto justify-center md:justify-start"><span>$1</span></button>`);
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, `<a href="$2" target="_blank" class="mt-3 flex items-center gap-2 bg-emerald-50 text-emerald-600 border border-emerald-100 px-5 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-emerald-600 hover:text-white transition-all shadow-sm w-full md:w-auto justify-center md:justify-start decoration-0"><span>$1</span></a>`);
            html = html.replace(/^\s*-\s+(.*)$/gm, '<li class="ml-4 list-disc marker:text-[#2E4982] pl-1 mb-1">$1</li>');
            html = html.replace(/(<li.*<\/li>)/s, '<ul class="my-2 space-y-1 text-left">$1</ul>');
            html = html.replace(/\n/g, '<br>');
            return html;
        };

        window.scrollToBottom = () => {
            const m = document.getElementById('ai-messages-mobile'), d = document.getElementById('ai-messages-desktop');
            if(m) m.scrollTop = m.scrollHeight; if(d) d.scrollTop = d.scrollHeight;
        };

        window.appendChatMessageToAll = (role, text) => {
            const content = role === 'ai' ? window.parseAIResponse(text) : text.replace(/\n/g, '<br>');
            const html = `<div class="flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-6 fade-in text-left"><div class="max-w-[85%] px-5 py-4 rounded-[1.4rem] text-[14px] leading-relaxed ${role === 'user' ? 'bg-[#2E4982] text-white rounded-tr-sm' : 'bg-white border border-slate-100 text-slate-600 rounded-tl-sm shadow-sm'}">${content}</div></div>`;
            const m = document.getElementById('ai-messages-mobile');
            const d = document.getElementById('ai-messages-desktop');
            if (m) {
                m.insertAdjacentHTML('beforeend', html);
                if(role === 'user') m.scrollTop = m.scrollHeight;
                else { const last = m.lastElementChild; if(last) requestAnimationFrame(() => last.scrollIntoView({behavior:'smooth', block:'start'})); }
            }
            if (d) {
                d.insertAdjacentHTML('beforeend', html);
                if(role === 'user') d.scrollTop = d.scrollHeight;
                else { const last = d.lastElementChild; if(last) requestAnimationFrame(() => last.scrollIntoView({behavior:'smooth', block:'start'})); }
            }
        };

        window.clearChat = () => {
            chatHistory = [];
            const info = currentAppData?.["Nombre + Edad"] || "Paciente";
            const welcome = `Hola <strong>${info.split(' ')[0]}</strong>, soy tu asistente personal. ¬øEn qu√© puedo guiarte hoy?`;
            const html = `<div class="flex justify-center mb-8"><p class="text-xs text-slate-400 font-medium uppercase tracking-widest">Hoy</p></div><div class="flex justify-start fade-in"><div class="max-w-[90%] bg-white border border-slate-100 px-6 py-4 rounded-[1.5rem] rounded-tl-sm text-[15px] leading-relaxed text-slate-600 shadow-sm">${welcome}</div></div>`;
            const m = document.getElementById('ai-messages-mobile'), d = document.getElementById('ai-messages-desktop');
            if(m) m.innerHTML = html; if(d) d.innerHTML = html;
        };

        window.handleAIAction = (viewId) => { window.closeDesktopAIModal(); if (viewId === 'program-detail-view') window.viewProgramResources(); else window.showView(viewId); };
        window.openDesktopAIModal = () => { const m = document.getElementById('ai-modal-overlay'); if(m){ m.classList.remove('hidden'); m.classList.add('flex'); setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('div')?.classList.remove('scale-95', 'opacity-0'); document.getElementById('ai-input-desktop')?.focus(); }, 10); }};
        window.closeDesktopAIModal = () => { const m = document.getElementById('ai-modal-overlay'); if(!m) return; m.classList.add('opacity-0'); m.querySelector('div')?.classList.add('scale-95', 'opacity-0'); setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); window.clearChat(); }, 300); };
        window.openAIChat = () => { if (window.innerWidth < 768) { window.showView('mobile-ai-view'); setTimeout(() => document.getElementById('ai-input-mobile')?.focus(), 300); } else window.openDesktopAIModal(); };
        window.closeMobileChat = () => { window.showView('patient-view'); window.clearChat(); };
        window.openAITrainingModal = () => { document.getElementById('ai-training-modal')?.classList.remove('hidden'); document.getElementById('ai-training-modal')?.classList.add('flex'); };
        window.closeAITrainingModal = () => { document.getElementById('ai-training-modal')?.classList.add('hidden'); };
        window.updateSpecMode = (val) => { specModeSelection = val; window.refreshUIWithData(); window.showView('patient-view'); };

        window.showInstallInstructions = () => {
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /ipad|iphone|ipod/.test(ua) && !window.MSStream;
            const isAndroid = /android/.test(ua);
            
            let msg = "";
            if (isIOS) {
                msg = `
                <div class="text-center space-y-6">
                    <div class="bg-slate-50 p-4 rounded-3xl inline-block border border-slate-100 shadow-sm">
                        <svg class="w-10 h-10 text-[#2E4982]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </div>
                    <div><h3 class="text-xl font-bold text-slate-800">iPhone / iPad</h3></div>
                    <ol class="text-sm text-slate-600 space-y-3 text-left bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <li class="flex gap-3"><span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0">1</span> <span>Toca el bot√≥n <strong>Compartir</strong> <svg class="w-4 h-4 inline text-[#2E4982] align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> abajo.</span></li>
                        <li class="flex gap-3"><span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0">2</span> <span>Selecciona <strong>"Agregar a Inicio"</strong>.</span></li>
                    </ol>
                    <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="w-full bg-[#2E4982] text-white py-4 rounded-xl font-bold text-xs uppercase shadow-xl tracking-widest hover:scale-[1.02] transition-transform">Entendido</button>
                </div>`;
            } else if (isAndroid) {
                msg = `
                 <div class="text-center space-y-6">
                    <div class="bg-slate-50 p-4 rounded-3xl inline-block border border-slate-100 shadow-sm">
                        <svg class="w-10 h-10 text-[#2E4982]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    <div><h3 class="text-xl font-bold text-slate-800">Android</h3></div>
                    <ol class="text-sm text-slate-600 space-y-3 text-left bg-slate-50 p-5 rounded-2xl border border-slate-100">
                         <li class="flex gap-3"><span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0">1</span> <span>Toca el men√∫ de opciones (los tres puntos <span class="font-bold">‚ãÆ</span>).</span></li>
                         <li class="flex gap-3"><span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0">2</span> <span>Selecciona <strong>"Instalar aplicaci√≥n"</strong> o "A√±adir a pantalla de inicio".</span></li>
                    </ol>
                    <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="w-full bg-[#2E4982] text-white py-4 rounded-xl font-bold text-xs uppercase shadow-xl tracking-widest hover:scale-[1.02] transition-transform">Entendido</button>
                </div>`;
            } else {
                 msg = `
                 <div class="text-center space-y-6">
                    <div class="bg-slate-50 p-4 rounded-3xl inline-block border border-slate-100 shadow-sm">
                        <svg class="w-10 h-10 text-[#2E4982]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    </div>
                    <div><h3 class="text-xl font-bold text-slate-800">PC / Chrome</h3></div>
                    <div class="text-left bg-slate-50 p-5 rounded-2xl border border-slate-100 text-sm text-slate-600 space-y-4">
                        <p class="flex items-start gap-3">
                            <span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0 mt-0.5">1</span>
                            <span>En la barra de direcciones (arriba a la derecha), busca este icono: <svg class="w-5 h-5 inline mx-1 border border-slate-300 rounded p-0.5 bg-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> <strong>(Instalar)</strong></span>
                        </p>
                        <p class="flex items-start gap-3">
                             <span class="bg-white border border-slate-200 rounded-full w-6 h-6 flex items-center justify-center font-bold text-[10px] shrink-0 mt-0.5">2</span>
                             <span>Si no aparece: Men√∫ (‚ãÆ) > <strong>Guardar y compartir</strong> > <strong>Instalar p√°gina como aplicaci√≥n...</strong></span>
                        </p>
                    </div>
                    <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="w-full bg-[#2E4982] text-white py-4 rounded-xl font-bold text-xs uppercase shadow-xl tracking-widest hover:scale-[1.02] transition-transform">Entendido</button>
                </div>`;
            }

            const modal = document.getElementById('install-modal');
            const content = document.getElementById('install-modal-content');
            if(modal && content) {
                content.innerHTML = msg;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.syncAIInstructions = async () => {
            if (!auth.currentUser) return;
            const aiDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'ai_config', 'instructions');
            onSnapshot(aiDocRef, (snap) => {
                const textEl = document.getElementById('ai-training-text');
                const infoEl = document.getElementById('ai-last-update');
                if (snap.exists()) {
                    const data = snap.data();
                    aiCustomInstructions = data.content || "";
                    if(textEl && document.activeElement !== textEl) textEl.value = aiCustomInstructions;
                    if(infoEl) {
                        const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : "Desconocido";
                        const user = data.updatedBy || "Sistema";
                        infoEl.innerHTML = `√öltima modificaci√≥n: <strong>${date}</strong><br>Por: ${user}`;
                    }
                }
            }, (err) => console.log("AI Sync Active"));
        };

        window.saveAITraining = async () => {
            const text = document.getElementById('ai-training-text').value;
            const btn = document.getElementById('btn-save-ai-training');
            if (!auth.currentUser) return;
            btn.disabled = true; btn.textContent = "Guardando...";
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ai_config', 'instructions'), { 
                    content: text, 
                    updatedBy: auth.currentUser?.email, 
                    timestamp: new Date() 
                });
                window.notify("Entrenamiento guardado", "success"); 
                window.closeAITrainingModal();
            } catch (e) { window.notify("Error al guardar"); }
            finally { btn.disabled = false; btn.textContent = "Guardar Cambios"; }
        };

        async function fetchWithRetry(url, options, retries = 3) {
            const backoffs = [1000, 2000, 4000, 8000];
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        if (i === retries) throw new Error("quota-exceeded");
                        await new Promise(r => setTimeout(r, backoffs[i]));
                        continue;
                    }
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries || error.message === "quota-exceeded") throw error;
                    await new Promise(r => setTimeout(r, backoffs[i]));
                }
            }
        }

        window.sendMessageToAI = async (source) => {
            const input = document.getElementById(source === 'mobile' ? 'ai-input-mobile' : 'ai-input-desktop');
            const userMsg = input?.value.trim();
            if (!userMsg) return;
            input.value = ''; if(source === 'mobile') input.blur();

            window.appendChatMessageToAll('user', userMsg);
            const loaderHtml = `<div class="ai-loading-indicator flex justify-start mb-4"><div class="bg-slate-100 text-slate-400 px-4 py-2 rounded-2xl text-[11px] animate-pulse italic">Analizando...</div></div>`;
            const m = document.getElementById('ai-messages-mobile');
            const d = document.getElementById('ai-messages-desktop');
            if(m) { m.insertAdjacentHTML('beforeend', loaderHtml); m.scrollTop = m.scrollHeight; }
            if(d) { d.insertAdjacentHTML('beforeend', loaderHtml); d.scrollTop = d.scrollHeight; }

            const info = currentAppData || {};
            const patientData = JSON.stringify(info, null, 2);

            const sysPrompt = `Eres el Asistente Personal AI de IMNUFIT. Hablas con **${info["Nombre + Edad"] || "Paciente"}**. 
            
            --- DATOS DEL PACIENTE (AIRTABLE) ---
            Usa estos datos como tu √∫nica fuente de verdad para preguntas personales.
            ${patientData}
            -------------------------------------

            INSTRUCCIONES CLAVE DEL ADMINISTRADOR: ${aiCustomInstructions}
            
            DIRECTRICES ESTRICTAS:
            1. **Estilo**: Responde de forma clara, precisa, amable y fluida. NO uses caracteres extra√±os. Respeta el formato de **negritas** y signos de puntuaci√≥n.
            2. **Formato Enlaces**: Cuando des un enlace, MUESTRA UN BOT√ìN usando el formato Markdown: [Texto del Bot√≥n](URL o funcion).
            3. **Alcance**: NUNCA respondas preguntas que no tengan nada que ver con IMNUFIT o la salud del paciente.
            4. **Prioridad Datos**: Para preguntas sobre dieta o plan, usa SOLO la informaci√≥n de Airtable (arriba).
            5. **Prohibido**: NO sugerir la "Gu√≠a PDF" como respuesta al plan diario.

            REGLAS DE ACCI√ìN OBLIGATORIAS:
            - **Reportarse**: Muestra [Llenar Reporte Mensual](https://airtable.com/appCHcm7XPzeoyBCs/pagh79fwniuSPmusB/form).
            - **Entrenar**: Muestra [Ver Entrenamientos](https://imnufit.com/entrenaconfrenplus/).
            - **Agendar Cita**: MUESTRA DOS BOTONES: [Reservar Cita](${info["Link Calendar"] || CALENDAR_LINK_DEFAULT}) Y [Llenar Reporte Mensual](https://airtable.com/appCHcm7XPzeoyBCs/pagh79fwniuSPmusB/form) (Solo si piden cita o reportarse).
            - **Ver Recursos/Manual**: SOLO si piden manuales o material de apoyo, muestra [Ver Gu√≠as PDF](function:program-detail-view).
            - **Ver Consultas**: Muestra [Historial de Consultas](${info["Link Consultas"] || "#"}).
            - **Contactar**: Muestra [Contactar Soporte](function:contact-view).
            - **Cancelar Membres√≠a/Clave**: Muestra [Mi Cuenta](function:membership-view). (NO ofrecer pausar).
            - **Precios/Web**: Muestra [Visitar Web](https://imnufit.com).
            - **Comunidad**: [Unirme a la Comunidad](https://chat.whatsapp.com/FNoToJXy8HO7iLVhPseQHB).`;

            try {
                const history = chatHistory.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] }));
                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [...history, { role: 'user', parts: [{ text: userMsg }] }], systemInstruction: { parts: [{ text: sysPrompt }] } })
                });
                const aiText = res.candidates?.[0]?.content?.parts?.[0]?.text || "No pude procesar tu solicitud.";
                
                document.querySelectorAll('.ai-loading-indicator').forEach(el => el.remove());
                window.appendChatMessageToAll('ai', aiText);
                chatHistory.push({ role: 'user', text: userMsg }, { role: 'ai', text: aiText });
            } catch (e) { 
                document.querySelectorAll('.ai-loading-indicator').forEach(el => el.remove());
                window.appendChatMessageToAll('ai', `‚ö†Ô∏è El coach est√° saturado. Reintenta en 1 min.`); 
            }
        };

        window.viewProgramResources = () => {
            const data = currentAppData;
            if (!data) return;
            const progKey = window.getProgramKey(data["Programa"] || "");
            if (!progKey || !PROGRAMAS_INFO[progKey]) { window.notify("Sin programa asignado"); return; }

            const progInfo = PROGRAMAS_INFO[progKey];
            const container = document.getElementById('program-guias-list');
            let mes = 1;
            if (data["Programa"].includes("Mes 2")) mes = 2;
            else if (data["Programa"].includes("Mes 3")) mes = 3;
            else if (data["Programa"].includes("Mes 4")) mes = 4;

            if (container) {
                container.innerHTML = "";
                for (let i = 1; i <= mes; i++) {
                    if (!progInfo.meses[i]) continue;
                    const card = document.createElement('div');
                    card.className = "w-full bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm mb-6 fade-in text-left";
                    card.innerHTML = `<h4 class="text-xs font-extrabold text-slate-400 uppercase tracking-[0.2em] mb-4 text-center">${progInfo.monthTitles?.[i] || 'MES ' + i}</h4>`;
                    const list = document.createElement('div'); list.className = "flex flex-col gap-3";
                    [...progInfo.meses[i]].sort((a,b) => a.type === 'VIDEO' ? 1 : -1).forEach(guia => {
                        const isVideo = guia.type === "VIDEO";
                        list.innerHTML += `<a href="${guia.url}" target="_blank" class="group flex items-start gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/30 transition-all text-left"><div class="w-12 h-12 rounded-xl ${isVideo ? 'bg-rose-100 text-rose-500' : 'bg-blue-100 text-[#2E4982]'} flex items-center justify-center shrink-0 text-center">${isVideo ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' : '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>'}</div><div class="text-left"><h4 class="text-sm font-bold text-slate-800">${guia.label}</h4><p class="text-xs text-slate-500 font-medium mt-1 leading-relaxed">${guia.desc}</p></div></a>`;
                    });
                    card.appendChild(list); container.appendChild(card);
                }
            }
            const imgEl = document.getElementById('program-img-main');
            if (imgEl) { 
                imgEl.src = progInfo.img; 
                document.getElementById('program-img-container').className = `flex justify-center mb-10 transition-transform duration-500 ${progInfo.imgWidth || 'w-32'}`;
                document.getElementById('program-img-container')?.classList.remove('hidden'); 
            }
            window.showView('program-detail-view');
        };

        window.refreshUIWithData = () => {
            if (isSpecialistMode) {
                let mockProg = specModeSelection === "adios_diabetes" ? "Adi√≥s Diabetes 2 (Mes 3)" : (specModeSelection === "quema_grasa" ? "Quema Grasa (Mes 4)" : (specModeSelection === "sano" ? "SANO (Mes 2)" : ""));
                let mockData = { ...cachedAirtableData, "Nombre + Edad": "Especialista (Demo)", "Programa": mockProg, "Estatus": "Activo", "Link Calendar": CALENDAR_LINK_DEFAULT, "Link Consultas": "https://airtable.com/" };
                updateDashboardUI(mockData);
            } else updateDashboardUI(cachedAirtableData);
        };
        
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.pass.value;
            const loader = document.getElementById('loading-screen');
            try {
                if(loader) loader.classList.remove('hidden');
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.log("Login fail:", error.code);
                if(loader) loader.classList.add('hidden');
                let msg = "Error al iniciar sesi√≥n.";
                if (['auth/invalid-credential', 'auth/user-not-found', 'auth/wrong-password', 'auth/invalid-email'].includes(error.code)) msg = "Correo o contrase√±a incorrectos.";
                else if (error.code === 'auth/too-many-requests') msg = "Demasiados intentos. Espera un momento.";
                window.notify(msg, 'error');
            }
        };

        window.handleSignup = async (e) => { 
            e.preventDefault(); 
            const email = e.target.email.value; 
            const pass = e.target.pass.value; 
            const confirmPass = e.target.confirmPass.value;
            
            if (pass.length < 6) { window.notify("La contrase√±a debe tener al menos 6 caracteres"); return; }
            if (pass !== confirmPass) { window.notify("Las contrase√±as no coinciden"); return; } 
            
            const loader = document.getElementById('loading-screen');
            if(loader) loader.classList.remove('hidden');

            try { 
                const airtableUser = await fetchAirtableData(email);
                if (!airtableUser) {
                    if(loader) loader.classList.add('hidden');
                    window.notify("Este correo no est√° registrado en nuestra base de datos. Debes ser atendido en consulta primero.");
                    return; 
                }
                
                const status = String(airtableUser["Estatus"] || "").toLowerCase();
                // REGLA ESTRICTA: SOLO ACTIVO
                if (!status.includes("activo") && !status.includes("act√≠vo")) {
                     if(loader) loader.classList.add('hidden');
                     window.notify("Tu cuenta no est√° activa. Ser√° activada en tu pr√≥xima consulta.");
                     return; 
                }
                
                if (status.includes("inactivo")) {
                     if(loader) loader.classList.add('hidden');
                     window.notify("Tu cuenta no est√° activa. Ser√° activada en tu pr√≥xima consulta.");
                     return; 
                }

                await createUserWithEmailAndPassword(auth, email, pass); 
                window.notify("Cuenta creada exitosamente", "success"); 
            } catch (err) { 
                if(loader) loader.classList.add('hidden');
                window.notify("Error: " + (err.code === 'auth/email-already-in-use' ? 'El correo ya est√° registrado.' : err.code)); 
            } 
        };

        window.handlePasswordReset = async (e) => { e.preventDefault(); try { document.getElementById('loading-screen')?.classList.remove('hidden'); await sendPasswordResetEmail(auth, e.target.resetEmail.value); window.notify("Correo enviado", "success"); window.showView('login-view'); } catch (err) { window.notify("Error"); } finally { document.getElementById('loading-screen')?.classList.add('hidden'); } };
        window.cerrarSesion = () => signOut(auth);
        window.updateAppPassword = async (e) => { e.preventDefault(); if(!auth.currentUser) return; try { document.getElementById('loading-screen')?.classList.remove('hidden'); await updatePassword(auth.currentUser, e.target.newPassword.value); window.notify("Clave actualizada", "success"); e.target.reset(); } catch (err) { window.notify("Sesi√≥n expirada"); } finally { document.getElementById('loading-screen')?.classList.add('hidden'); } };

        window.refreshData = async () => { if(auth.currentUser) { document.getElementById('loading-screen')?.classList.remove('hidden'); const f = encodeURIComponent(`(LOWER({Email})=LOWER('${auth.currentUser.email}'))`), u = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${f}`; const res = await fetch(u, { headers: { Authorization: `Bearer ${AIRTABLE_PAT}` } }); const d = await res.json(); cachedAirtableData = d.records?.[0]?.fields || null; 
        
        // VALIDACI√ìN DE ESTATUS EN REFRESH
        if (!isSpecialistMode) {
             if (!cachedAirtableData) {
                  window.notify("Usuario no encontrado en base de datos.");
                  await signOut(auth);
                  if(document.getElementById('loading-screen')) document.getElementById('loading-screen').classList.add('hidden');
                  return;
             }
             const status = String(cachedAirtableData["Estatus"] || "").toLowerCase();
             if (status.includes("inactivo") || (!status.includes("activo") && !status.includes("act√≠vo"))) {
                  window.notify("Tu cuenta no est√° activa. Ser√° activada en tu pr√≥xima consulta.");
                  await signOut(auth);
                  if(document.getElementById('loading-screen')) document.getElementById('loading-screen').classList.add('hidden');
                  return;
             }
        }
        
        window.refreshUIWithData(); setTimeout(() => { document.getElementById('loading-screen')?.classList.add('hidden'); window.notify("Datos actualizados", "success"); }, 600); } };

        async function fetchAirtableData(email) {
            const f = encodeURIComponent(`(LOWER({Email})=LOWER('${email}'))`), u = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${f}`;
            try { const res = await fetch(u, { headers: { Authorization: `Bearer ${AIRTABLE_PAT}` } }); const data = await res.json(); return data.records?.[0]?.fields || null; } catch (e) { return null; }
        }

        function updateDashboardUI(data) {
            if (!data) return;
            currentAppData = data; 
            window.safeSetText('display-nombre', data["Nombre + Edad"] || "Usuario IMNUFIT");
            if (chatHistory.length === 0) window.clearChat();
            const g = window.getGreeting(); window.safeUpdate('display-greeting', (el) => el.innerHTML = `<span class="text-xl mr-2">${g.icon}</span> ${g.text}`);
            
            const st = data["Estatus"] || "Activo";
            window.safeUpdate('display-estatus', (el) => { el.textContent = st; el.className = `px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest border inline-block mt-2 ${window.getStatusClass(st)}`; });
            
            document.getElementById('featured-plan-banner')?.classList.toggle('hidden', !data.Programa);
            if (data.Programa) window.safeSetText('plan-banner-title', data.Programa);
            
            // SHOW ALL CARDS
            ['card-entrenamientos', 'card-reporte', 'card-citas', 'card-consultas', 'card-community', 'card-install-app-main'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('hidden');
            });

            // LOGICA INTELIGENTE: Si la App ya est√° instalada, ocultamos el bot√≥n del main
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            if (isStandalone) {
                document.getElementById('card-install-app-main')?.classList.add('hidden');
            }

            // CHECK LINK CONSULTAS
            const linkCons = data["Link Consultas"];
            const cardCons = document.getElementById('card-consultas');
            if (cardCons) {
                if (!linkCons || linkCons.trim() === "") cardCons.classList.add('hidden');
                else {
                    cardCons.classList.remove('hidden');
                    const btn = document.getElementById('btn-consultas-action');
                    if (btn) { btn.href = linkCons; btn.style.opacity = "1"; }
                }
            }

            window.safeUpdate('calendar-action-container', el => el.innerHTML = `<a href="${data["Link Calendar"] || CALENDAR_LINK_DEFAULT}" target="_blank" class="btn-ghost-sm text-center">Ir al Calendario</a>`);
            const bh = document.getElementById('btn-consultas-action'); if (bh) { bh.href = data["Link Consultas"] || "#"; bh.style.opacity = bh.href.includes("#") ? "0.4" : "1"; }
            
            window.safeSetText('acc-nombre', data["Nombre + Edad"] || "---"); window.safeSetText('acc-email', auth.currentUser?.email || "--"); window.safeSetText('display-frase', frasesCreyentes[Math.floor(Math.random() * frasesCreyentes.length)]);
            window.safeSetText('acc-pais', data["Pa√≠s"] || "--"); window.safeSetText('acc-telefono', data["Telefono"] || "--");
            window.safeSetText('acc-nacimiento', window.formatDateMDY(data["Fecha de Nacimiento"]));
            
            const genero = String(data["G√©nero"] || "");
            window.safeUpdate('acc-genero', el => {
                el.textContent = genero;
                if (genero.toLowerCase().includes("masculino")) el.className = "px-4 py-1.5 rounded-full text-[10px] font-extrabold bg-sky-50 text-sky-600 border border-sky-100 uppercase tracking-widest inline-block shadow-sm";
                else if (genero.toLowerCase().includes("femenino")) el.className = "px-4 py-1.5 rounded-full text-[10px] font-extrabold bg-rose-50 text-rose-600 border border-rose-100 uppercase tracking-widest shadow-sm inline-block";
                else el.className = "hidden";
            });
        }

        // --- AUTH OBSERVER (GATEKEEPER BLINDADO) ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.classList.remove('hidden');
            if (user) {
                window.resetUI();
                window.resetInactivityTimer();
                isSpecialistMode = (user.email === SPECIALIST_EMAIL);
                const sp = document.getElementById('specialist-panel'); if(sp) sp.classList.toggle('hidden', !isSpecialistMode);
                cachedAirtableData = await fetchAirtableData(user.email);
                
                // REGLA DE ORO: SI NO EXISTE EN AIRTABLE -> FUERA
                if (!isSpecialistMode) {
                    if (!cachedAirtableData) {
                         window.notify("Usuario no encontrado en base de datos.");
                         await signOut(auth);
                         if(loader) loader.classList.add('hidden');
                         return;
                    }
                    
                    const status = String(cachedAirtableData["Estatus"] || "").toLowerCase();
                    
                    // REGLA ESTRICTA DE "INACTIVO"
                    if (status.includes("inactivo")) {
                         window.notify("Tu cuenta no est√° activa. Ser√° activada en tu pr√≥xima consulta.");
                         await signOut(auth);
                         if(loader) loader.classList.add('hidden');
                         return;
                    }

                    // REGLA DE "SOLO ACTIVO"
                    if (!status.includes("activo") && !status.includes("act√≠vo")) {
                         window.notify("Tu cuenta no est√° activa. Ser√° activada en tu pr√≥xima consulta.");
                         await signOut(auth);
                         if(loader) loader.classList.add('hidden');
                         return;
                    }
                }

                window.refreshUIWithData(); window.syncAIInstructions(); window.showView('patient-view', false);
            } else { 
                window.resetUI(); 
                const sp = document.getElementById('specialist-panel'); if(sp) sp.classList.add('hidden');
                isSpecialistMode = false; window.showView('login-view', false); 
            }
            if(loader) loader.classList.add('hidden');
        });

        // --- INIT ---
        setPersistence(auth, browserLocalPersistence).then(() => {});

    </script>
    <style>
        :root { --primary: #2E4982; --apple-bg: #FBFBFC; }
        body { font-family: 'Inter', sans-serif; background-color: var(--apple-bg); color: #494949; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        .bg-mesh { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 80% 20%, #DEE9FA 0%, transparent 40%), radial-gradient(circle at 20% 80%, #E7E3FB 0%, transparent 40%); opacity: 0.4; }
        .bento-card { @apply bg-white/90 backdrop-blur-xl border border-white transition-all duration-500 flex flex-col justify-between; border-radius: 40px; padding: 36px 32px !important; box-shadow: 0 10px 30px -5px rgba(46, 73, 130, 0.05); }
        .bento-card:hover { transform: translateY(-4px); box-shadow: 0 25px 50px -10px rgba(46, 73, 130, 0.12); }
        .btn-ingresar { background-color: var(--primary); color: #FFFFFF; width: 100%; padding: 20px !important; border-radius: 100px; font-weight: 600; font-size: 15px; border: none; transition: all 0.4s ease; box-shadow: 0 10px 20px -5px rgba(46, 73, 130, 0.25); cursor: pointer; text-align: center; }
        .btn-ghost-sm { background-color: transparent; color: var(--primary); border: 1.5px solid var(--primary); padding: 14px 20px !important; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; transition: all 0.3s ease; display: inline-block; text-align: center; width: 100%; }
        .btn-ghost-sm:hover { background-color: #DEE9FA; border-color: #DEE9FA; }
        .btn-secure-portal { background-color: #2E4982; color: white; width: 100%; padding: 18px !important; border-radius: 14px; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 10px 20px -5px rgba(46, 73, 130, 0.2); text-align: center; }
        .profile-line { @apply border-b border-slate-50 py-7 last:border-0; }
        .profile-label-text { @apply text-[10px] font-extrabold text-slate-400 uppercase tracking-[0.3em] block mb-2; }
        .profile-value-text { @apply text-[14px] text-slate-500 font-medium leading-relaxed; }
        .input-apple { width: 100%; padding: 18px 22px !important; border: 1.5px solid #E5E7EB !important; border-radius: 18px; background-color: #FFFFFF; outline: none; font-size: 15px; transition: all 0.3s ease; }
        .input-apple:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 4px #DEE9FA; }
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .mix-blend-multiply { mix-blend-mode: multiply; }
        #specialist-panel { background: #2E4982; border-bottom: 2px solid #1e315a; position: sticky; top: 0; z-index: 500; color: white; padding: 10px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .spec-select { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 10px; font-weight: 700; padding: 6px 12px; outline: none; color: white; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .spec-select option { color: #333; }
        @keyframes ai-breathing { 0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.2), 0 0 40px rgba(59, 130, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); } 50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.4), 0 0 60px rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); } }
        .ai-card-glow { animation: ai-breathing 4s infinite ease-in-out; background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-[#DEE9FA] selection:text-[#2E4982]">

    <div class="bg-mesh"></div>
    
    <!-- PANEL MAESTRO ESPECIALISTA -->
    <div id="specialist-panel" class="hidden">
        <div class="max-w-5xl mx-auto flex flex-wrap items-center justify-between gap-3 text-left">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2"><span class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-300">Modo Demo:</span><select class="spec-select" onchange="window.updateSpecMode(this.value)"><option value="sin_programa">Sin Programa</option><option value="quema_grasa">Quema Grasa</option><option value="sano">SANO</option><option value="adios_diabetes">Adi√≥s Diabetes 2</option></select></div>
                <button onclick="window.openAITrainingModal()" class="bg-white/20 hover:bg-white/30 text-white text-[9px] font-black uppercase tracking-widest px-4 py-2 rounded-lg border border-white/20 transition-all flex items-center gap-2 text-center justify-center"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Entrenar IA</button>
            </div>
            <p class="hidden md:block text-[9px] opacity-60 italic text-white">Admin: imnufit@gmail.com</p>
        </div>
    </div>

    <!-- MODAL ENTRENAMIENTO IA -->
    <div id="ai-training-modal" class="fixed inset-0 z-[3000] bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden fade-in flex flex-col max-h-[90vh]">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-[#2E4982] text-white">
                <div class="text-left"><h3 class="text-xl font-bold">Cerebro de IA</h3><p class="text-[10px] uppercase font-black tracking-widest opacity-60">Entrenamiento</p></div>
                <button onclick="window.closeAITrainingModal()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M6 18L18 6M6 6l18 18"></path></svg></button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto text-left custom-scrollbar">
                
                <!-- MONITOR CEREBRAL -->
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 flex justify-between items-start">
                     <div>
                         <div class="flex items-center gap-2 mb-1">
                            <span class="text-indigo-600 text-xs">üß†</span>
                            <h4 class="text-[10px] font-black text-indigo-800 uppercase tracking-widest">Memoria Activa</h4>
                         </div>
                         <p id="ai-last-update" class="text-[10px] text-indigo-600/80 font-medium leading-relaxed">Sincronizando...</p>
                     </div>
                     <div class="h-2 w-2 bg-green-500 rounded-full animate-pulse mt-1"></div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Instrucciones de Entrenamiento</label>
                    <textarea id="ai-training-text" rows="12" placeholder="Escribe aqu√≠ las reglas, tono, o conocimientos espec√≠ficos..." class="w-full p-5 bg-slate-50 border border-slate-200 rounded-[1.5rem] outline-none focus:ring-2 focus:ring-[#2E4982]/20 focus:border-[#2E4982] text-[13px] text-slate-700 leading-relaxed transition-all resize-none font-medium custom-scrollbar"></textarea>
                </div>

                <button id="btn-save-ai-training" onclick="window.saveAITraining()" class="w-full bg-[#2E4982] text-white py-5 rounded-full font-bold uppercase tracking-widest text-xs shadow-xl active:scale-95 transition-all text-center">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- M√ìVIL CHAT VIEW -->
    <section id="mobile-ai-view" class="h-[100dvh] hidden bg-[#FBFBFC] text-left flex flex-col fixed inset-0 z-[2000]">
        <header class="h-24 flex items-center px-6 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 shrink-0 text-left">
            <button onclick="window.closeMobileChat()" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button>
            <div class="flex flex-col items-center text-center"><span class="text-[10px] font-bold text-[#2E4982] uppercase tracking-[0.3em] text-center">Asistente</span><div class="flex items-center gap-1.5"><span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span><span class="text-[10px] font-medium text-emerald-600 uppercase tracking-wider text-center">En l√≠nea</span></div></div><div class="w-10"></div>
        </header>
        <div id="ai-messages-mobile" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth text-left"></div>
        <div class="p-4 bg-white border-t border-slate-50 shrink-0 text-left">
            <form onsubmit="event.preventDefault(); window.sendMessageToAI('mobile')" class="relative flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-[1.5rem] px-2 py-2">
                <input id="ai-input-mobile" type="text" placeholder="Escribe..." class="flex-1 bg-transparent border-none outline-none px-4 py-3 text-slate-700 text-[15px]">
                <button type="submit" class="w-12 h-12 bg-[#2E4982] text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-transform text-center"><svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
            </form>
        </div>
    </section>

    <!-- DESKTOP MODAL CHAT -->
    <div id="ai-modal-overlay" class="fixed inset-0 z-[2000] bg-white/30 backdrop-blur-xl hidden opacity-0 transition-opacity duration-300 items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl h-[70vh] rounded-[2.5rem] shadow-2xl border border-white/60 flex flex-col overflow-hidden scale-95 opacity-0 transition-all duration-300 relative pointer-events-auto text-left">
            <div class="h-16 flex items-center justify-between px-8 border-b border-slate-50 shrink-0 bg-white/80 backdrop-blur-md z-10 text-left">
                <div class="flex flex-col text-left"><span class="font-bold text-sm text-slate-800 text-left">Asistente IMNUFIT</span><div class="flex items-center gap-1.5 mt-0.5"><span class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span></span><span class="text-[9px] font-bold text-emerald-600 uppercase tracking-widest text-left">En l√≠nea</span></div></div>
                <button onclick="window.closeDesktopAIModal()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-colors text-center"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M6 18L18 6M6 6l18 18"></path></svg></button>
            </div>
            <div id="ai-messages-desktop" class="flex-1 overflow-y-auto p-8 space-y-6 scroll-smooth bg-[#FBFBFC] text-left"></div>
            <div class="p-6 bg-white shrink-0 text-left">
                <form onsubmit="event.preventDefault(); window.sendMessageToAI('desktop')" class="relative flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-[1.5rem] px-2 py-2">
                    <input id="ai-input-desktop" type="text" placeholder="Pregunta..." class="flex-1 bg-transparent outline-none px-4 py-3 text-slate-700 text-[15px]">
                    <button type="submit" class="w-12 h-12 bg-[#2E4982] hover:bg-[#1e315a] text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 text-center"><svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN VIEWS -->
    <section id="patient-view" class="min-h-screen hidden text-left">
        <header class="bg-white/40 backdrop-blur-xl border-b h-24 flex items-center px-8 justify-between sticky top-0 z-40 text-left">
            <button onclick="window.showView('patient-view')" class="hover:opacity-80 transition-opacity"><img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="h-10 object-contain mix-blend-multiply"></button>
            <div class="flex items-center gap-3 text-left">
                <a href="https://imnufit.com" target="_blank" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group text-center" title="Ir a web"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg></a>
                <button onclick="window.refreshData()" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group text-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                <button onclick="window.showView('contact-view')" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group text-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
                <button onclick="window.showView('membership-view')" class="w-10 h-10 rounded-full bg-[#DEE9FA] flex items-center justify-center text-[#2E4982] hover:bg-[#2E4982] hover:text-white transition-all shadow-sm text-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
                <button onclick="window.cerrarSesion()" class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest hover:text-red-500 ml-2">Salir</button>
            </div>
        </header>

        <main class="max-w-5xl mx-auto py-12 px-6 space-y-12 text-left">
            <div class="space-y-6 text-left">
                <div class="text-left"><p id="display-greeting" class="text-[10px] font-bold text-[#2E4982] uppercase tracking-[0.5em] mb-1 flex items-center text-left"></p><h2 class="text-2xl font-bold tracking-tight text-[#494949] leading-tight text-left"><span id="display-nombre">...</span></h2><div class="pt-2 text-left"><span id="display-estatus" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase border inline-block text-left">Cargando...</span></div></div>
                <div class="bg-white/60 p-6 rounded-[2rem] border border-white/60 shadow-sm backdrop-blur-md max-w-3xl text-slate-600 text-left"><p id="display-frase" class="italic text-[15px] leading-relaxed text-left">...</p></div>
                <div id="featured-plan-banner" class="hidden fade-in text-left"><div class="bg-[#2E4982] rounded-[2.5rem] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden group cursor-pointer text-left" onclick="window.viewProgramResources()"><div class="absolute -right-16 -top-16 w-64 h-64 bg-white/10 rounded-full blur-3xl text-left"></div><div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-8 text-left"><div class="space-y-3 text-left"><span class="text-[10px] font-bold uppercase tracking-[0.4em] opacity-60 text-left">Tu Programa Asignado</span><h3 id="plan-banner-title" class="text-xl md:text-2xl font-bold tracking-tight text-left">...</h3><p class="text-white/50 text-sm max-w-sm italic font-medium leading-relaxed text-left">Accede a tus recursos exclusivos acumulados.</p></div><button class="bg-white text-[#2E4982] px-8 py-4 rounded-full text-[11px] font-extrabold uppercase tracking-widest shadow-xl group-hover:scale-105 transition-transform shrink-0 text-center">Ver Recursos</button></div></div></div>
                <div id="restricted-banner" class="hidden fade-in text-left"><div class="bg-[#2E4982] rounded-[2.5rem] p-10 md:p-12 text-white shadow-2xl relative overflow-hidden text-center flex flex-col items-center text-left"><div class="absolute -right-16 -top-16 w-64 h-64 bg-white/10 rounded-full blur-3xl text-left"></div><div class="relative z-10 space-y-4 max-w-xl text-center"><span id="restricted-banner-title" class="text-[10px] font-bold uppercase tracking-[0.4em] opacity-60 text-center text-left">Portal</span><h3 class="text-xl md:text-2xl font-bold tracking-tight text-white text-center">Tu Salud es Prioridad</h3><p id="restricted-banner-body" class="text-white/70 text-[14px] font-medium leading-relaxed text-center text-left"></p><div id="restricted-btn-container" class="w-full text-center"></div></div></div></div>
            </div>

            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <section id="card-ai" class="ai-card-glow rounded-[2.5rem] p-8 border border-white/50 relative overflow-hidden cursor-pointer group transition-transform hover:-translate-y-1 text-left" onclick="window.openAIChat()">
                    <div class="relative z-10 flex flex-col justify-between h-full min-h-[220px] text-left">
                        <div class="flex items-start justify-between text-left"><div><span class="px-3 py-1 bg-white/50 backdrop-blur-md rounded-full text-[10px] font-extrabold text-[#2E4982] uppercase tracking-[0.2em] border border-white/60 text-left">Nuevo</span><h3 class="text-2xl font-bold text-slate-800 mt-3 leading-tight text-left">Asistente<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-600 to-blue-500 text-left">Inteligente</span></h3></div><div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-violet-100 to-blue-50 flex items-center justify-center text-blue-600 shadow-sm text-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div></div>
                        <div class="space-y-4 text-left"><p class="text-[14px] text-slate-500 font-medium leading-relaxed text-left">"¬øQu√© puedo comer si tengo antojo de dulce?"</p><div class="flex items-center gap-2 text-xs font-bold text-[#2E4982] group-hover:gap-3 transition-all text-left"><span>Iniciar conversaci√≥n</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div></div>
                    </div>
                    <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-gradient-to-tr from-blue-200 to-violet-200 rounded-full blur-[60px] opacity-60 pointer-events-none text-left"></div>
                </section>
                <section id="card-entrenamientos" class="bento-card min-h-[300px] text-left"><div class="w-14 h-14 bg-[#DEE9FA] rounded-2xl flex items-center justify-center mb-6 shrink-0 text-center"><img src="https://imnufit.com/wp-content/uploads/2022/01/iuiuo.png" class="w-11 h-11 object-contain text-left"></div><div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Entrenaconfren+</h4><h3 class="text-2xl font-bold text-[#494949] text-left">Entrenamientos</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Accede a tus rutinas y gu√≠as.</p></div><div class="mt-8 text-center text-left"><a href="https://imnufit.com/entrenaconfrenplus/" target="_blank" class="btn-ghost-sm text-center">Ir a Entrenar</a></div></section>
                <section id="card-reporte" class="bento-card min-h-[300px] text-left"><div class="w-14 h-14 bg-[#FFEDD5] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-center"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div><div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Seguimiento</h4><h3 class="text-2xl font-bold text-[#494949] text-left">Reporte Mensual</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Registra tus progresos.</p></div><div class="mt-8 text-center text-left"><a href="https://airtable.com/appCHcm7XPzeoyBCs/pagh79fwniuSPmusB/form" target="_blank" class="btn-ghost-sm text-center">Llenar Reporte</a></div></section>
                <section id="card-citas" class="bento-card min-h-[300px] text-left"><div class="w-14 h-14 bg-[#D0F0E0] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-center"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Citas</h4><h3 class="text-2xl font-bold text-[#494949] text-left">Reservar Consulta</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Gestiona tu espacio aqu√≠.</p></div><div id="calendar-action-container" class="mt-8 text-center w-full text-center"></div></section>
                <section id="card-consultas" class="bento-card min-h-[300px] text-left"><div class="w-14 h-14 bg-[#E7E3FB] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-center"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div><div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Registro</h4><h3 class="text-2xl font-bold text-[#494949] text-left">Consultas Recientes</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Historial de evaluaciones.</p></div><div class="mt-8 text-center text-center"><a id="btn-consultas-action" href="#" target="_blank" class="btn-ghost-sm text-center">Abrir Historial</a></div></section>
                
                <!-- CARD COMUNIDAD (NUEVA) -->
                <section id="card-community" class="bento-card min-h-[300px] text-left">
                    <div class="w-14 h-14 bg-[#DCFCE7] rounded-2xl flex items-center justify-center mb-6 text-[#16A34A] shrink-0 text-center">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                    <div class="text-left">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Comunidad</h4>
                        <h3 class="text-2xl font-bold text-[#494949] text-left">Grupo VIP</h3>
                        <p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">√önete a nuestra comunidad exclusiva en WhatsApp.</p>
                    </div>
                    <div class="mt-8 text-center text-left">
                        <a href="https://chat.whatsapp.com/FNoToJXy8HO7iLVhPseQHB" target="_blank" class="btn-ghost-sm text-center">Unirme Ahora</a>
                    </div>
                </section>
                
                <!-- CARD "INSTALAR APP" EN EL GRID PRINCIPAL (INTELIGENTE) -->
                <div id="card-install-app-main" class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-[2rem] p-8 text-white shadow-xl relative overflow-hidden group cursor-pointer hidden text-left" onclick="window.showInstallInstructions()">
                     <div class="absolute -right-8 -top-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                     <div class="relative z-10 flex items-center justify-between">
                         <div>
                             <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/60">Acceso R√°pido</span>
                             <h3 class="text-lg font-bold mt-1">Instalar App</h3>
                             <p class="text-[12px] text-white/70 mt-1 max-w-[200px]">A√±ade IMNUFIT a tu pantalla de inicio para una mejor experiencia.</p>
                         </div>
                         <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                         </div>
                     </div>
                </div>

            </div>
        </main>
    </section>

    <!-- PROGRAM DETAIL VIEW -->
    <section id="program-detail-view" class="min-h-screen hidden bg-[#FBFBFC] text-center text-left">
        <header class="h-24 flex items-center px-4 md:px-8 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 text-left"><button onclick="window.closeMobileChat()" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors group text-left flex-shrink-0 text-left"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button><span class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-center flex-1 mx-2 text-center text-center">Recursos del Programa</span><div class="w-10"></div></header>
        <main class="max-w-xl mx-auto py-16 px-6 fade-in space-y-12 flex flex-col items-center text-center text-left"><div id="program-img-container" class="flex justify-center text-left transition-transform duration-500 w-32"><img id="program-img-main" src="" class="object-contain mix-blend-multiply text-center"></div><div id="program-guias-list" class="grid gap-5 text-left w-full text-left"></div><p class="text-slate-300 text-[10px] font-medium italic text-center">¬© IMNUFIT ‚Äî Nutrici√≥n con Prop√≥sito</p></main>
    </section>

    <!-- CONTACT VIEW -->
    <section id="contact-view" class="min-h-screen hidden bg-white text-left">
        <header class="h-24 flex items-center px-8 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 text-left"><button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors text-left"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button><span class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-left text-left">Contacto</span><div class="w-10 text-left"></div></header>
        <main class="max-w-xl mx-auto py-16 px-6 fade-in space-y-12 text-left"><div class="text-center space-y-4 text-left"><h3 class="text-2xl font-bold text-slate-800 tracking-tight text-left">Atenci√≥n al Paciente</h3><p class="text-slate-500 text-sm text-left">Estamos aqu√≠ para apoyarte en tu camino.</p></div><div class="bg-[#2E4982] rounded-[2.5rem] p-8 md:p-10 text-white shadow-xl space-y-8 relative overflow-hidden text-left"><div class="absolute -right-16 -top-16 w-48 h-48 bg-white/5 rounded-full blur-2xl text-left"></div><div class="flex items-center gap-5 text-left"><div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center shrink-0 text-center"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.246 2.248 3.484 5.232 3.483 8.413-.003 6.557-5.338 11.892-11.893 11.892-1.997-.001-3.951-.5-5.688-1.448l-6.308 1.655zm6.205-4.105l.345.205c1.332.793 2.839 1.211 4.382 1.212 4.793 0 8.694-3.901 8.697-8.694 0-2.324-.904-4.509-2.547-6.152-1.642-1.642-3.827-2.547-6.15-2.547-4.796 0-8.696 3.901-8.699 8.694 0 1.646.463 3.253 1.339 4.653l.225.362-.977 3.564 3.65-.958z"/></svg></div><div class="text-left"><h4 class="font-bold text-xl text-left">Soporte WhatsApp</h4><p class="text-white/60 text-xs font-black uppercase tracking-widest mt-1 text-left">Chat directo</p></div></div><div class="space-y-4 bg-white/10 p-6 rounded-3xl backdrop-blur-sm border border-white/5 text-left"><p class="text-[10px] font-black uppercase tracking-[0.3em] text-white/50 text-left">Horario de Atenci√≥n (EE.UU. Este)</p><div class="grid grid-cols-1 gap-3 text-left"><div class="flex justify-between items-center text-sm font-semibold text-left"><span>Lunes - Viernes</span><span class="opacity-90 text-left">10:00 am - 6:00 pm</span></div><div class="flex justify-between items-center text-[10px] uppercase font-black tracking-widest text-white/40 pt-2 border-t border-white/5 text-left"><span>S√°bados - Domingos</span><span class="italic text-left">Cerrado</span></div></div></div><a href="https://wa.me/14076325438" target="_blank" class="block w-full bg-white text-[#2E4982] py-5 rounded-full text-[11px] font-black uppercase tracking-widest text-center shadow-lg hover:scale-[1.02] transition-transform text-center">Iniciar Chat</a></div>
            <div class="grid gap-4 text-left">
                <p class="text-slate-300 text-[10px] font-black uppercase tracking-[0.5em] text-center text-left">Nuestras Redes</p>
                <div class="grid gap-3 text-left">
                    <a href="https://www.instagram.com/imnufit/" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">IG</span><span class="text-sm font-bold text-slate-700 text-left">Instagram</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                    <a href="https://www.youtube.com/@entrenaconfren" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">YT</span><span class="text-sm font-bold text-slate-700 text-left">YouTube</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                    <a href="https://www.facebook.com/entrenaconfren" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">FB</span><span class="text-sm font-bold text-slate-700 text-left">Facebook</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                </div>
            </div>
            <div class="pt-8 border-t border-slate-50 text-center"><a href="mailto:imnufit@gmail.com" class="inline-block space-y-1 text-left"><p class="text-slate-300 text-[9px] font-black uppercase tracking-[0.4em] text-left">Email Oficial</p><p class="text-slate-600 font-bold text-sm hover:text-[#2E4982] transition-colors text-left">imnufit@gmail.com</p></a></div>
        </main>
    </section>

    <!-- ACCOUNT VIEW -->
    <section id="membership-view" class="min-h-screen hidden bg-slate-50/50 pb-20 text-left">
        <header class="bg-white/40 backdrop-blur-xl border-b h-24 flex items-center px-8 justify-between sticky top-0 z-40 text-left"><button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors text-left"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button><h2 class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-left">Mi Cuenta</h2><div class="w-10"></div></header>
        <main class="max-w-2xl mx-auto py-12 px-6 space-y-10 text-left">
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left"><div class="flex items-center gap-4 mb-12 text-left"><div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-[#2E4982] shadow-sm text-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div class="text-left"><h3 class="text-xl font-bold">Perfil Personal</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Identidad en Consulta</p></div></div><div class="space-y-0 text-left"><div class="profile-line text-left"><span class="profile-label-text">Paciente:</span><span id="acc-nombre" class="profile-value-text">...</span></div><div class="profile-line flex items-center justify-start !py-6 text-left"><span id="acc-genero">--</span></div><div class="profile-line text-left"><span class="profile-label-text">Nacimiento:</span><span id="acc-nacimiento" class="profile-value-text">--</span></div><div class="profile-line text-left"><span class="profile-label-text">Pa√≠s:</span><span id="acc-pais" class="profile-value-text">--</span></div><div class="profile-line border-0 text-left"><span class="profile-label-text">Tel√©fono:</span><span id="acc-telefono" class="profile-value-text">--</span></div><div class="mt-4 pt-10 border-t border-slate-50 text-left"><span class="profile-label-text !mb-1 text-left">Email de acceso</span><div class="h-1 text-left"></div><span id="acc-email" class="text-[14px] font-medium text-slate-500">--</span></div></div></section>
            
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left"><div class="flex items-center gap-4 mb-8 text-left"><div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-500 shadow-sm text-left"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg></div><div class="text-left"><h3 class="text-xl font-bold text-[#494949]">Seguridad</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Cambio de Acceso</p></div></div><form onsubmit="window.updateAppPassword(event)" class="space-y-6 text-left"><div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1 text-left">Nueva Contrase√±a</label><input type="password" name="newPassword" required minlength="6" placeholder="Nueva contrase√±a (m√≠n. 6 caracteres)" class="input-apple mt-2 text-left"></div><button type="submit" class="btn-ingresar !bg-slate-800 text-center">Actualizar Contrase√±a</button></form></section>
            
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left">
                <div class="flex items-center gap-4 mb-8 text-left">
                    <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm text-left"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg></div>
                    <div class="text-left"><h3 class="text-xl font-bold text-[#494949]">Membres√≠a</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Gesti√≥n de Suscripci√≥n</p></div>
                </div>
                <p class="text-[14px] text-slate-500 mb-8 leading-relaxed text-left">Utilizamos una plataforma segura para tus suscripciones. Desde aqu√≠ podr√°s actualizar tu tarjeta o <strong>cancelar tu membres√≠a</strong>.</p>
                <div class="w-full">
                    <a href="https://billing.stripe.com/p/login/bIY9CF3un99T2XefYY" target="_blank" class="btn-secure-portal w-full justify-center text-center">
                        Gestionar Membres√≠a y Pagos 
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>
            </section>

            <button onclick="window.cerrarSesion()" class="w-full py-4 text-xs font-bold text-red-400 uppercase tracking-widest text-center">Cerrar Sesi√≥n</button>
        </main>
    </section>

    <!-- LOGIN VIEW RESTAURADO -->
    <section id="login-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center text-left">
        <div class="max-w-[340px] w-full space-y-12 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply text-center">
            <div class="space-y-2 text-center text-left">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949] text-center">Portal del Paciente</h1>
                <p class="text-[14px] text-slate-500 text-center">Inicia sesi√≥n para continuar</p>
            </div>
            <form onsubmit="window.handleLogin(event)" class="space-y-6 text-center text-left">
                <input type="email" name="email" required placeholder="Correo electr√≥nico" class="input-apple text-center text-left">
                <div class="space-y-3 text-center text-left">
                    <input type="password" name="pass" required placeholder="Contrase√±a" class="input-apple text-center text-left">
                    <div class="text-center text-left"><button type="button" onclick="window.showView('forgot-password-view')" class="text-[11px] font-bold text-[#2E4982] uppercase tracking-widest hover:underline text-center text-left">¬øOlvidaste tu contrase√±a?</button></div>
                </div>
                <div class="space-y-5 text-center text-left">
                    <button type="submit" class="btn-ingresar text-center text-center">Entrar al portal</button>
                    <button type="button" onclick="window.showView('signup-view')" class="text-[12px] font-extrabold text-[#2E4982] uppercase tracking-tight text-center text-left">
                        ¬øEres nuevo? <span class="border-b border-[#2E4982]/30 pb-0.5 text-center">Crea tu cuenta aqu√≠</span>
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- SIGNUP VIEW RESTAURADO -->
    <section id="signup-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center text-left">
        <div class="max-w-[340px] w-full space-y-12 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply text-center">
            <div class="space-y-2 text-center text-left">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949] text-center">Crear tu cuenta</h1>
                <p class="text-[14px] text-slate-500 text-center text-left">Usa el correo registrado en consulta</p>
            </div>
            <form onsubmit="window.handleSignup(event)" class="space-y-6 text-center text-left">
                <input type="email" name="email" required placeholder="Correo electr√≥nico" class="input-apple text-center text-left">
                <input type="password" name="pass" required minlength="6" placeholder="Contrase√±a" class="input-apple text-center text-left">
                <input type="password" name="confirmPass" required minlength="6" placeholder="Confirmar contrase√±a" class="input-apple text-center text-left">
                <button type="submit" class="btn-ingresar mt-4 text-center text-center">Registrarme</button>
            </form>
            <button onclick="window.showView('login-view')" class="text-[11px] font-bold text-[#2E4982] uppercase tracking-widest hover:underline text-center text-left">¬øYa tienes cuenta? Inicia sesi√≥n</button>
        </div>
    </section>

    <!-- FORGOT PASSWORD VIEW RESTAURADO -->
    <section id="forgot-password-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center text-left">
        <div class="max-w-[340px] w-full space-y-10 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply text-center">
            <div class="space-y-2 text-center text-left">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949] text-center text-left">Recuperar Acceso</h1>
                <p class="text-[14px] text-slate-500 text-center text-left">Te enviaremos un enlace a tu correo</p>
            </div>
            <form onsubmit="window.handlePasswordReset(event)" class="space-y-6 text-center text-left">
                <input type="email" name="resetEmail" required placeholder="Correo de acceso" class="input-apple text-center text-left">
                <button type="submit" class="btn-ingresar text-center text-center">Enviar enlace</button>
                <p class="text-[12px] text-slate-700 font-bold text-center text-left">üí° Si no recibes el correo, revisa tu carpeta de Spam.</p>
            </form>
            <button onclick="window.showView('login-view')" class="text-[12px] font-bold text-[#2E4982] uppercase tracking-widest w-full text-center text-left">Volver al inicio</button>
        </div>
    </section>

    <!-- NOTIFICATION TOAST -->
    <div id="notification-toast" class="hidden fixed top-8 left-1/2 -translate-x-1/2 z-[9999] px-8 py-4 rounded-full shadow-2xl text-[13px] font-semibold bg-white border transform transition-all duration-300" style="z-index: 10000;">
        <span id="notification-content"></span>
    </div>
    
    <!-- INSTALL MODAL -->
    <div id="install-modal" class="fixed inset-0 z-[10000] bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4">
        <div id="install-modal-content" class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl space-y-6 transform transition-all scale-100">
            <!-- Content injected by JS -->
        </div>
    </div>
    
    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[9000] flex items-center justify-center hidden">
        <div class="h-8 w-8 border-[3px] border-[#2E4982] border-t-transparent rounded-full animate-spin"></div>
    </div>

</body>
</html>
