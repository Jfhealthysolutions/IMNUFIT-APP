<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMNUFIT - Portal del Paciente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJBf7TbP1GuAoA3GsrCG0EJOifEt4YodY",
            authDomain: "imnufit-cad14.firebaseapp.com",
            projectId: "imnufit-cad14",
            storageBucket: "imnufit-cad14.firebasestorage.app",
            messagingSenderId: "65610345018",
            appId: "1:65610345018:web:eac15a30c72084faac6303"
        };

        const AIRTABLE_PAT = "patZ9QUQVyldn9zKC.afb4fc362eb2f79b1aa10faf3fb3268ea6bca3f57a1362b83f6cc8459a50f0d3"; 
        const AIRTABLE_BASE_ID = "appCHcm7XPzeoyBCs"; 
        const AIRTABLE_TABLE_NAME = "Pacientes"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GESTI√ìN INTERNA DE LA API KEY (OCULTA) ---
        const _partA = "AIzaSyCPDuual8XB";
        const _partB = "ejuVUPbKecfonbIh6SNolDk";
        const apiKey = _partA + _partB;

        // --- CONFIGURACI√ìN MODO ESPECIALISTA ---
        const SPECIALIST_EMAIL = "imnufit@gmail.com";
        let isSpecialistMode = false;
        let specModeSelection = "sin_programa";

        const CALENDAR_LINK_DEFAULT = "https://calendar.app.google/CE4KjKxPeFiV93GV7";
        const PLANES_LINK = "https://imnufit.com/planes-y-precios/";
        
        // --- PROMPT POR DEFECTO ---
        const DEFAULT_SYSTEM_PROMPT = `Eres el Especialista IA de IMNUFIT. Tu objetivo es motivar y guiar al paciente en su programa nutricional.
        Tu tono es profesional, motivador y breve. Usa negritas para resaltar ideas clave.
        IMPORTANTE: Si el usuario quiere realizar una acci√≥n, usa este formato para botones: [TEXTO](link_o_funcion)`;

        let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;

        // --- RECURSOS POR PROGRAMA Y MES ---
        const PROGRAMAS_INFO = {
            "Adi√≥s Diabetes 2": {
                img: "https://imnufit.com/wp-content/uploads/2024/04/Imagen-de-WhatsApp-2024-04-30-a-las-18.35.48_16bb1ed2.jpg",
                imgWidth: "w-48 md:w-56",
                meses: {
                    1: [{ label: "Gu√≠a Nutricional - Mes 1", desc: "Nueva Edici√≥n (Dic 2025): Desintoxicaci√≥n", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-1-Nueva-Edicion.pdf", type: "PDF" }],
                    2: [{ label: "Gu√≠a Nutricional - Mes 2", desc: "Nueva Edici√≥n (Dic 2025): Control Gluc√©mico", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-2-Nueva-Edicion.pdf", type: "PDF" }],
                    3: [{ label: "Gu√≠a Nutricional - Mes 3", desc: "Nueva Edici√≥n (Dic 2025): Mantenimiento", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-3-Nueva-Edicion.pdf", type: "PDF" }]
                }
            },
            "Quema Grasa": {
                img: "https://imnufit.com/wp-content/uploads/2022/04/qg.png",
                imgWidth: "w-36 md:w-40",
                monthTitles: {
                    1: "MES 1 - DEPURACI√ìN",
                    2: "MES 2 - SACIEDAD",
                    3: "MES 3 - AYUNO INICIAL",
                    4: "MES 4 - AYUNO 16-18"
                },
                meses: {
                    1: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Eliminaremos los comestibles que te enferman.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-1-Completo-Depuracion.pdf", type: "PDF" },
                        { label: "Video Explicativo.", desc: "Res√∫men del mes.", url: "https://youtu.be/iO5ihFR8Vrg", type: "VIDEO" }
                    ],
                    2: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Aprender√° a saciarse a trav√©s de una nutrici√≥n densa.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-2-Completo-Saciedad.pdf", type: "PDF" },
                        { label: "Video Explicativo.", desc: "Res√∫men del mes.", url: "https://youtu.be/AeIQAgoc0Fc", type: "VIDEO" }
                    ],
                    3: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Su organismo entrar√° en ayuno intermitente de forma natural.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-3-Completo-Ayuno-Inicial.pdf", type: "PDF" },
                        { label: "Video Explicativo.", desc: "Res√∫men del mes.", url: "https://youtu.be/CTevX300uG8", type: "VIDEO" }
                    ],
                    4: [
                        { label: "Gu√≠a PDF Descargable", desc: "Objetivo: Conocer√° y experimentar√° los beneficios de un ayuno saludable prolongado.", url: "https://imnufit.com/wp-content/uploads/2025/12/Mes-4-Completo-Ayuno16-18.pdf", type: "PDF" },
                        { label: "Video Explicativo.", desc: "Res√∫men del mes.", url: "https://youtu.be/15VyQaKcOU4", type: "VIDEO" }
                    ]
                }
            },
            "SANO": { 
                img: "https://imnufit.com/wp-content/uploads/2023/11/Sano-logo-1-e1755541161822.png", 
                imgWidth: "w-32 md:w-36",
                meses: {
                    1: [
                        { label: "Manual SANO - Mes 1", desc: "Plan de Alimentaci√≥n Consciente", url: "https://imnufit.com/wp-content/uploads/2023/12/SANO-MES-1.pdf", type: "PDF" },
                        { label: "Playlist de Videos Educativos", desc: "Lo que debes saber de las industrias y la Salud", url: "https://www.youtube.com/playlist?list=PLYjLMUD2ZGJd9qcLx7vXRVtcWkLtg5oAc", type: "VIDEO" }
                    ],
                    2: [
                        { label: "Manual SANO - Mes 2", desc: "Consolidaci√≥n de Nuevos H√°bitos", url: "https://imnufit.com/wp-content/uploads/2024/02/SANO-Mes-2.pdf", type: "PDF" }
                    ]
                }
            }
        };

        const frasesCreyentes = [
            "Todo lo puedo en Cristo que me fortalece. ‚Äî Filipenses 4:13",
            "Su amor es constante y nuevo cada ma√±ana. ‚Äî Lamentaciones 3:22",
            "El Se√±or es mi pastor, nada me faltar√°. ‚Äî Salmos 23:1",
            "Jehov√° es mi fortaleza y mi escudo. ‚Äî Salmos 28:7",
            "Conf√≠a en el Se√±or de todo coraz√≥n. ‚Äî Proverbios 3:5",
            "Mira que te mando que te esfuerces y seas valiente. ‚Äî Josu√© 1:9"
        ];

        setPersistence(auth, browserLocalPersistence);

        // --- UTILIDADES ---
        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
        const safeUpdate = (id, fn) => { const el = document.getElementById(id); if (el) fn(el); };

        window.formatDateMDY = (dateString) => {
            if (!dateString) return "--";
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; 
            const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
            const dd = String(date.getUTCDate()).padStart(2, '0');
            const yyyy = date.getUTCFullYear();
            return `${mm}/${dd}/${yyyy}`;
        };

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return { text: "Buenos d√≠as", icon: "‚òÄÔ∏è" };
            if (hour >= 12 && hour < 18) return { text: "Buenas tardes", icon: "‚òÄÔ∏è" };
            return { text: "Buenas noches", icon: "üåô" };
        }

        function getStatusClass(status) {
            if (!status) return "bg-slate-50 text-slate-400 border-slate-100";
            const s = String(status).toLowerCase();
            if (s.includes("inactivo")) return "bg-rose-50 text-red-600 border-rose-200";
            if (s.includes("activo") || s.includes("act√≠vo")) return "bg-emerald-50 text-emerald-600 border-emerald-100";
            return "bg-amber-50 text-amber-600 border-amber-100";
        }

        function getProgramKey(programName) {
            if (!programName) return null;
            const p = programName.toLowerCase();
            if (p.includes("quema grasa")) return "Quema Grasa";
            if (p.includes("sano")) return "SANO";
            if (p.includes("adi√≥s diabetes 2") || p.includes("adios diabetes 2")) return "Adi√≥s Diabetes 2";
            return null;
        }

        // --- L√ìGICA DE CONFIGURACI√ìN IA (FIRESTORE) ---
        async function loadSystemPrompt() {
            try {
                const docRef = doc(db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'config', 'main');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists() && docSnap.data().system_prompt) {
                    currentSystemPrompt = docSnap.data().system_prompt;
                    console.log("Prompt de IA cargado desde la nube.");
                } else {
                    console.log("Usando Prompt por defecto.");
                }
            } catch (error) {
                console.error("Error cargando configuraci√≥n IA:", error);
            }
        }

        window.saveSystemPrompt = async () => {
            const newPrompt = document.getElementById('admin-prompt-input').value;
            if (!newPrompt) return window.notify("El prompt no puede estar vac√≠o");
            
            document.getElementById('loading-screen').classList.remove('hidden');
            try {
                const docRef = doc(db, 'artifacts', firebaseConfig.appId, 'public', 'data', 'config', 'main');
                await setDoc(docRef, { system_prompt: newPrompt }, { merge: true });
                currentSystemPrompt = newPrompt;
                window.notify("Entrenamiento guardado. La IA ahora usar√° estas instrucciones.", "success");
                window.showView('patient-view');
            } catch (error) {
                console.error(error);
                window.notify("Error al guardar: " + error.message);
            } finally {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        };

        // --- L√ìGICA DE IA (GEMINI) ---
        let chatHistory = [];

        async function fetchWithRetry(url, options, retries = 2) {
            const backoffs = [1000, 2000, 4000];
            for (let i = 0; i <= retries; i++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000); 
                
                try {
                    const response = await fetch(url, { 
                        ...options, 
                        signal: controller.signal,
                        referrerPolicy: 'no-referrer',
                        mode: 'cors'
                    });
                    clearTimeout(timeoutId);

                    if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                        throw new Error(`Error API (${response.status})`);
                    }

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (i === retries || error.message.includes('Error API')) throw error;
                    await new Promise(r => setTimeout(r, backoffs[i]));
                }
            }
        }

        function parseAIResponse(text) {
            if (!text) return "";
            
            // FIX NEGRITAS
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900">$1</strong>');
            
            // Cursivas
            html = html.replace(/\*(.*?)\*/g, '<em class="italic text-slate-600">$1</em>');
            
            // Botones
            html = html.replace(/\[([^\]]+)\]\(function:([a-zA-Z0-9-]+)\)/g, 
                `<button type="button" onclick="window.handleAIAction('$2')" class="mt-3 flex items-center gap-2 bg-[#2E4982]/10 text-[#2E4982] px-5 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-[#2E4982] hover:text-white transition-all shadow-sm w-full md:w-auto justify-center md:justify-start"><span>$1</span></button>`
            );
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, 
                `<a href="$2" target="_blank" class="mt-3 flex items-center gap-2 bg-emerald-50 text-emerald-600 border border-emerald-100 px-5 py-3 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-emerald-600 hover:text-white transition-all shadow-sm w-full md:w-auto justify-center md:justify-start decoration-0"><span>$1</span></a>`
            );
            
            // Listas
            html = html.replace(/^\s*-\s+(.*)$/gm, '<li class="ml-4 list-disc marker:text-[#2E4982] pl-1 mb-1">$1</li>');
            html = html.replace(/(<li.*<\/li>)/s, '<ul class="my-2 space-y-1">$1</ul>');
            
            // Saltos de l√≠nea
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        window.handleAIAction = (viewId) => {
            window.closeDesktopAIModal();
            // FIX: CARGAR RECURSOS SI ES LA VISTA DEL PROGRAMA
            if (viewId === 'program-detail-view' && typeof window.viewProgramResources === 'function') {
                 window.viewProgramResources();
            } else {
                 window.showView(viewId);
            }
        };

        window.openAIChat = () => {
            const isMobile = window.innerWidth < 768; 
            if (isMobile) {
                window.showView('mobile-ai-view');
                setTimeout(() => { const el = document.getElementById('ai-input-mobile'); if(el) el.focus(); }, 300);
            } else {
                window.openDesktopAIModal();
            }
        };

        window.openDesktopAIModal = () => {
            const modal = document.getElementById('ai-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                document.getElementById('ai-input-desktop').focus();
            }, 10);
        };

        window.closeDesktopAIModal = () => {
            const modal = document.getElementById('ai-modal-overlay');
            if(!modal) return;
            modal.classList.add('opacity-0');
            modal.querySelector('div')?.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        };

        // --- APERTURA PANEL ENTRENAMIENTO ---
        window.openAdminTraining = () => {
            document.getElementById('admin-prompt-input').value = currentSystemPrompt;
            window.showView('admin-training-view');
        }

        window.sendMessageToAI = async (source) => {
            const inputId = source === 'mobile' ? 'ai-input-mobile' : 'ai-input-desktop';
            const input = document.getElementById(inputId);
            const userMessage = input.value.trim();
            if (!userMessage) return;

            // VERIFICACI√ìN DE SEGURIDAD
            if (!apiKey || apiKey.length < 10) {
                window.notify("Error: Falta API Key", "error");
                return;
            }

            input.value = '';
            if(source === 'mobile') input.blur();

            appendChatMessageToAll('user', userMessage);
            
            const loadingHtml = `<div class="ai-loading-indicator flex justify-start mb-4"><div class="bg-slate-100 text-slate-400 px-4 py-2 rounded-2xl text-[11px] animate-pulse italic">Analizando...</div></div>`;
            document.getElementById('ai-messages-mobile').insertAdjacentHTML('beforeend', loadingHtml);
            document.getElementById('ai-messages-desktop').insertAdjacentHTML('beforeend', loadingHtml);
            scrollToBottom();

            const nombreCompleto = cachedAirtableData?.["Nombre + Edad"] || "Paciente";
            const nombrePila = nombreCompleto.split(' ')[0] || "Paciente";
            const linkCalendar = cachedAirtableData?.["Link Calendar"] || CALENDAR_LINK_DEFAULT;
            const linkConsultas = cachedAirtableData?.["Link Consultas"] || "https://airtable.com/";
            const programaActual = cachedAirtableData?.Programa || 'No asignado a√∫n';
            
            // CONSTRUCCI√ìN DEL PROMPT FINAL
            // Ajustado para evitar saludos repetitivos y corregido el link de historial
            const finalPrompt = `
            ${currentSystemPrompt}
            
            DATOS DEL PACIENTE:
            - Nombre: ${nombreCompleto} (${nombrePila})
            - Programa Actual: ${programaActual}
            
            INSTRUCCIONES ADICIONALES:
            - El usuario ya sabe qui√©n eres. NO saludes con "Hola..." en cada respuesta. S√© directo y √∫til.
            - Usa negritas para palabras clave.
            
            HERRAMIENTAS DISPONIBLES (Usa estos links exactos):
            - Ver Entrenamientos: [Ir a Entrenamientos](https://imnufit.com/entrenaconfrenplus/)
            - Reportar Progreso: [Llenar Reporte Mensual](https://airtable.com/appCHcm7XPzeoyBCs/pagh79fwniuSPmusB/form)
            - Agendar Cita: [Reservar Cita](${linkCalendar})
            - Historial M√©dico: [Ver Consultas](${linkConsultas})
            - Contactar Soporte: [Contactar Soporte](function:contact-view)
            - Ver Perfil/Pagos: [Mi Cuenta](function:membership-view)
            - Recursos del Programa: [Ver Gu√≠as PDF](function:program-detail-view)
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userMessage }] }],
                    systemInstruction: { parts: [{ text: finalPrompt }] }
                };

                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar tu mensaje.";
                appendChatMessageToAll('ai', aiText);
                chatHistory.push({ role: 'user', text: userMessage }, { role: 'ai', text: aiText });

            } catch (error) {
                console.error("AI Error:", error);
                let displayError = "Error de conexi√≥n.";
                if (error.message.includes("403")) displayError = "Acceso denegado. Clave bloqueada.";
                appendChatMessageToAll('ai', `‚ö†Ô∏è <strong>No pude responder.</strong><br><span class="text-[10px] opacity-70">${displayError}</span>`);
                window.notify("Error en la IA");
            } finally {
                document.querySelectorAll('.ai-loading-indicator').forEach(el => el.remove());
            }
        };

        function appendChatMessageToAll(role, text) {
            const contentHtml = role === 'ai' ? parseAIResponse(text) : text.replace(/\n/g, '<br>');
            const msgHtml = `
                <div class="flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-6 fade-in">
                    <div class="max-w-[85%] px-5 py-4 rounded-[1.4rem] text-[14px] leading-relaxed ${role === 'user' ? 'bg-[#2E4982] text-white rounded-tr-sm' : 'bg-white border border-slate-100 text-slate-600 rounded-tl-sm shadow-sm'}">
                        ${contentHtml}
                    </div>
                </div>
            `;
            document.getElementById('ai-messages-mobile').insertAdjacentHTML('beforeend', msgHtml);
            document.getElementById('ai-messages-desktop').insertAdjacentHTML('beforeend', msgHtml);
            scrollToBottom();
        }

        function scrollToBottom() {
            setTimeout(() => {
                const mob = document.getElementById('ai-messages-mobile');
                const desk = document.getElementById('ai-messages-desktop');
                if(mob) mob.scrollTop = mob.scrollHeight;
                if(desk) desk.scrollTop = desk.scrollHeight;
            }, 50);
        }

        window.showView = (viewId, saveHistory = true) => {
            const views = ['login-view', 'signup-view', 'patient-view', 'membership-view', 'program-detail-view', 'forgot-password-view', 'contact-view', 'mobile-ai-view', 'admin-training-view'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('hidden', id !== viewId);
            });
            window.scrollTo(0,0);
            if (saveHistory) history.pushState({ viewId }, "", "");
        };

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.viewId) {
                window.showView(event.state.viewId, false);
            } else {
                const user = auth.currentUser;
                window.showView(user ? 'patient-view' : 'login-view', false);
            }
        });

        window.notify = (message, type = 'error') => {
            const toast = document.getElementById('notification-toast');
            const content = document.getElementById('notification-content');
            if(toast && content) {
                content.textContent = message;
                toast.className = `fixed top-8 left-1/2 -translate-x-1/2 z-[800] px-8 py-4 rounded-full shadow-2xl text-[13px] font-semibold bg-white border ${type === 'success' ? 'text-emerald-600 border-emerald-100' : 'text-red-600 border-red-100'}`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3500);
            }
        };

        window.updateSpecMode = (val) => {
            specModeSelection = val;
            refreshUIWithData();
            window.showView('patient-view');
        };

        let cachedAirtableData = null;

        function refreshUIWithData() {
            if (isSpecialistMode) {
                let mockProgram = "";
                switch(specModeSelection) {
                    case "adios_diabetes": mockProgram = "Adi√≥s Diabetes 2 (Mes 3)"; break;
                    case "quema_grasa": mockProgram = "Quema Grasa (Mes 4)"; break;
                    case "sano": mockProgram = "SANO (Mes 2)"; break;
                    default: mockProgram = "";
                }

                const mock = {
                    ...cachedAirtableData,
                    "Nombre + Edad": "Especialista IMNUFIT (Demo)",
                    "Programa": mockProgram,
                    "Estatus": "Activo",
                    "Link Calendar": CALENDAR_LINK_DEFAULT,
                    "Link Consultas": "#"
                };
                updateDashboardUI(mock);
            } else {
                updateDashboardUI(cachedAirtableData);
            }
        }

        async function fetchAirtableData(email) {
            if (!AIRTABLE_PAT || !AIRTABLE_BASE_ID) return null;
            const formula = encodeURIComponent(`({Email}='${email}')`);
            const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${formula}`;
            try {
                const response = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_PAT}` } });
                const data = await response.json();
                return data.records && data.records.length > 0 ? data.records[0].fields : null;
            } catch (error) { return null; }
        }

        function updateDashboardUI(airtableData) {
            if (!airtableData) return;
            const infoPaciente = airtableData["Nombre + Edad"] || "Usuario IMNUFIT";
            safeSetText('display-nombre', infoPaciente);
            const nombrePila = infoPaciente.split(' ')[0] || "Paciente";
            const welcomeMsg = `Hola <strong>${nombrePila}</strong>, soy tu asistente personal de nutrici√≥n. Conozco cada detalle de tu plan en IMNUFIT. ¬øEn qu√© puedo guiarte hoy?`;
            const mobWel = document.getElementById('ai-welcome-text-mobile');
            const deskWel = document.getElementById('ai-welcome-text-desktop');
            if (mobWel) mobWel.innerHTML = welcomeMsg;
            if (deskWel) deskWel.innerHTML = welcomeMsg;
            const g = getGreeting();
            safeUpdate('display-greeting', (el) => el.innerHTML = `<span class="text-xl mr-2">${g.icon}</span> ${g.text}`);
            const status = airtableData["Estatus"] || "Activo";
            safeUpdate('display-estatus', (el) => {
                el.textContent = status;
                el.className = `px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest border inline-block mt-2 ${getStatusClass(status)}`;
            });
            const rawProgramName = airtableData["Programa"] || "";
            const progKey = getProgramKey(rawProgramName);
            let currentMesNum = 1;
            if (rawProgramName.includes("Mes 2")) currentMesNum = 2;
            else if (rawProgramName.includes("Mes 3")) currentMesNum = 3;
            else if (rawProgramName.includes("Mes 4")) currentMesNum = 4;
            const sLow = status.toLowerCase();
            const isInactive = sLow.includes("inactivo");
            const isPorAsignar = sLow.includes("por asignar");
            const isPausa = sLow.includes("pausa");
            const isRestricted = (isInactive || isPorAsignar || isPausa) && !isSpecialistMode;
            const featuredBanner = document.getElementById('featured-plan-banner');
            const restrictedBanner = document.getElementById('restricted-banner');
            const aiCard = document.getElementById('card-ai');

            if (isRestricted) {
                if (featuredBanner) featuredBanner.classList.add('hidden');
                if (restrictedBanner) restrictedBanner.classList.remove('hidden');
                if (aiCard) aiCard.classList.add('hidden');
                safeSetText('restricted-banner-title', isPorAsignar ? "Plan en Preparaci√≥n" : "Portal de Seguimiento");
                safeSetText('restricted-banner-body', isPorAsignar ? "Tu membres√≠a est√° activa y estamos dise√±ando tu estrategia personalizada. Tu plan ser√° asignado oficialmente en nuestra pr√≥xima consulta. ¬°Estamos listos para empezar!" : "Tu membres√≠a no tiene un plan activo en este momento. Puedes consultar nuestras opciones de suscripci√≥n en nuestra web oficial.");
                const restrictedBtnCont = document.getElementById('restricted-btn-container');
                if (restrictedBtnCont) {
                    if (isInactive) {
                        const histLink = airtableData["Link Consultas"] || "#";
                        restrictedBtnCont.innerHTML = `<div class="flex flex-col sm:flex-row gap-4 items-center justify-center mt-6 text-center"><a href="${PLANES_LINK}" target="_blank" class="bg-white text-[#2E4982] px-10 py-5 rounded-full text-[12px] font-black uppercase tracking-widest shadow-2xl hover:scale-105 transition-transform w-full sm:w-auto">Ver Planes</a><a href="${histLink}" target="_blank" class="bg-white/10 text-white border border-white/20 px-10 py-5 rounded-full text-[12px] font-black uppercase tracking-widest hover:bg-white/20 transition-all w-full sm:w-auto">Consultas Anteriores</a></div>`;
                    } else { restrictedBtnCont.innerHTML = ""; }
                }
            } else {
                if (restrictedBanner) restrictedBanner.classList.add('hidden');
                if (aiCard) aiCard.classList.remove('hidden');
                if (progKey && PROGRAMAS_INFO[progKey] && featuredBanner) {
                    featuredBanner.classList.remove('hidden');
                    safeSetText('plan-banner-title', rawProgramName);
                    window.viewProgramResources = () => {
                        const data = PROGRAMAS_INFO[progKey];
                        const container = document.getElementById('program-guias-list');
                        if (container) {
                            container.innerHTML = "";
                            for (let i = 1; i <= currentMesNum; i++) {
                                if (!data.meses[i]) continue;
                                const monthCard = document.createElement('div');
                                monthCard.className = "w-full bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm mb-6 fade-in";
                                monthCard.style.animationDelay = `${(i-1)*0.1}s`;
                                let monthTitleText = `MES ${i}`;
                                if (data.monthTitles && data.monthTitles[i]) monthTitleText = data.monthTitles[i];
                                monthCard.innerHTML = `<h4 class="text-xs font-extrabold text-slate-400 uppercase tracking-[0.2em] mb-4 text-center">${monthTitleText}</h4>`;
                                const list = document.createElement('div');
                                list.className = "flex flex-col gap-3";
                                const sortedRes = [...data.meses[i]].sort((a,b) => a.type === 'VIDEO' ? 1 : -1);
                                sortedRes.forEach(guia => {
                                    const isVideo = guia.type === "VIDEO";
                                    list.innerHTML += `
                                        <a href="${guia.url}" target="_blank" class="group flex items-start gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/30 hover:border-[#DEE9FA] transition-all duration-300">
                                            <div class="w-12 h-12 rounded-xl ${isVideo ? 'bg-rose-100 text-rose-500' : 'bg-blue-100 text-[#2E4982]'} flex items-center justify-center shrink-0">
                                                ${isVideo ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>' : '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>'}
                                            </div>
                                            <div class="text-left">
                                                <h4 class="text-sm font-bold text-slate-800 group-hover:text-[#2E4982]">${guia.label}</h4>
                                                <p class="text-xs text-slate-500 font-medium mt-1 leading-relaxed">${guia.desc}</p>
                                            </div>
                                        </a>`;
                                });
                                monthCard.appendChild(list);
                                container.appendChild(monthCard);
                            }
                        }
                        const imgMain = document.getElementById('program-img-main');
                        if (imgMain) {
                            imgMain.src = data.img;
                            document.getElementById('program-img-container').className = `flex justify-center mb-10 transition-transform duration-500 ${data.imgWidth || 'w-32'}`;
                        }
                        window.showView('program-detail-view');
                    };
                } else if (featuredBanner) { featuredBanner.classList.add('hidden'); }
            }
            const hideCards = (isInactive || isPorAsignar) && !isSpecialistMode;
            ['card-entrenamientos', 'card-reporte', 'card-citas', 'card-consultas', 'card-ai'].forEach(id => {
                safeUpdate(id, el => el.classList.toggle('hidden', hideCards));
            });
            if (isPausa && !isSpecialistMode) {
                ['card-entrenamientos', 'card-reporte', 'card-citas', 'card-ai'].forEach(id => safeUpdate(id, el => el.classList.add('hidden')));
                safeUpdate('card-consultas', el => el.classList.remove('hidden'));
            }
            const calLink = airtableData["Link Calendar"] || CALENDAR_LINK_DEFAULT;
            safeUpdate('calendar-action-container', el => el.innerHTML = `<a href="${calLink}" target="_blank" class="btn-ghost-sm text-center">Ir al Calendario</a>`);
            const btnHist = document.getElementById('btn-consultas-action');
            if (btnHist) {
                btnHist.href = airtableData["Link Consultas"] || "#";
                btnHist.style.opacity = btnHist.href.includes("#") ? "0.4" : "1";
            }
            safeSetText('acc-nombre', infoPaciente);
            safeSetText('acc-nacimiento', window.formatDateMDY(airtableData["Fecha de Nacimiento"]));
            safeSetText('acc-email', auth.currentUser?.email || "--");
            safeSetText('acc-pais', airtableData["Pa√≠s"] || "--");
            safeSetText('acc-telefono', airtableData["Telefono"] || "--");
            const genero = String(airtableData["G√©nero"] || "");
            safeUpdate('acc-genero', el => {
                el.textContent = genero;
                if (genero.toLowerCase().includes("masculino")) el.className = "px-4 py-1.5 rounded-full text-[10px] font-extrabold bg-sky-50 text-sky-600 border border-sky-100 uppercase tracking-widest inline-block shadow-sm";
                else if (genero.toLowerCase().includes("femenino")) el.className = "px-4 py-1.5 rounded-full text-[10px] font-extrabold bg-rose-50 text-rose-600 border border-rose-100 uppercase tracking-widest shadow-sm inline-block";
                else el.className = "hidden";
            });
            safeSetText('display-frase', frasesCreyentes[Math.floor(Math.random() * frasesCreyentes.length)]);
        }

        window.refreshData = async () => {
            const user = auth.currentUser;
            if(user) {
                document.getElementById('loading-screen').classList.remove('hidden');
                const airtableData = await fetchAirtableData(user.email);
                cachedAirtableData = airtableData;
                refreshUIWithData();
                document.getElementById('loading-screen').classList.add('hidden');
                window.notify("Datos actualizados", "success");
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loading-screen').classList.remove('hidden');
                isSpecialistMode = (user.email === SPECIALIST_EMAIL);
                const panel = document.getElementById('specialist-panel');
                if(panel) {
                    panel.classList.toggle('hidden', !isSpecialistMode);
                }
                const airtableData = await fetchAirtableData(user.email);
                cachedAirtableData = airtableData;
                
                // CARGAR CONFIGURACI√ìN IA
                await loadSystemPrompt();
                
                refreshUIWithData();
                window.showView('patient-view', false);
            } else { 
                const panel = document.getElementById('specialist-panel');
                if(panel) panel.classList.add('hidden');
                isSpecialistMode = false;
                window.showView('login-view', false); 
            }
            document.getElementById('loading-screen').classList.add('hidden');
        });

        window.handleLogin = async (e) => { e.preventDefault(); const { email, pass } = e.target; try { document.getElementById('loading-screen').classList.remove('hidden'); await signInWithEmailAndPassword(auth, email.value, pass.value); } catch (err) { window.notify("Credenciales incorrectas"); document.getElementById('loading-screen').classList.add('hidden'); } };
        window.handleSignup = async (e) => { e.preventDefault(); const { email, pass, confirmPass } = e.target; if (pass.value !== confirmPass.value) { window.notify("Contrase√±as no coinciden"); return; } try { document.getElementById('loading-screen').classList.remove('hidden'); await createUserWithEmailAndPassword(auth, email.value, pass.value); window.notify("Cuenta creada", "success"); } catch (err) { window.notify("Error al registrar"); } finally { document.getElementById('loading-screen').classList.add('hidden'); } };
        window.handlePasswordReset = async (e) => { e.preventDefault(); const email = e.target.resetEmail.value; try { document.getElementById('loading-screen').classList.remove('hidden'); await sendPasswordResetEmail(auth, email); window.notify("Correo enviado", "success"); window.showView('login-view'); } catch (err) { window.notify("Error de env√≠o"); } finally { document.getElementById('loading-screen').classList.add('hidden'); } };
        window.updateAppPassword = async (e) => { e.preventDefault(); const newPass = e.target.newPassword.value; const user = auth.currentUser; if(!user) return; try { document.getElementById('loading-screen').classList.remove('hidden'); await updatePassword(user, newPass); window.notify("Clave actualizada", "success"); e.target.reset(); } catch (err) { window.notify("Sesi√≥n expirada"); } finally { document.getElementById('loading-screen').classList.add('hidden'); } };
        window.cerrarSesion = () => signOut(auth);
    </script>
    <style>
        :root { --primary: #2E4982; --apple-bg: #FBFBFC; }
        body { font-family: 'Inter', sans-serif; background-color: var(--apple-bg); color: #494949; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        .bg-mesh { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 80% 20%, #DEE9FA 0%, transparent 40%), radial-gradient(circle at 20% 80%, #E7E3FB 0%, transparent 40%); opacity: 0.4; }
        .bento-card { @apply bg-white/90 backdrop-blur-xl border border-white transition-all duration-500 flex flex-col justify-between; border-radius: 40px; padding: 36px 32px !important; box-shadow: 0 10px 30px -5px rgba(46, 73, 130, 0.05); }
        .bento-card:hover { transform: translateY(-4px); box-shadow: 0 25px 50px -10px rgba(46, 73, 130, 0.12); }
        .btn-ingresar { background-color: var(--primary); color: #FFFFFF; width: 100%; padding: 20px !important; border-radius: 100px; font-weight: 600; font-size: 15px; border: none; transition: all 0.4s ease; box-shadow: 0 10px 20px -5px rgba(46, 73, 130, 0.25); cursor: pointer; text-align: center; }
        .btn-ghost-sm { background-color: transparent; color: var(--primary); border: 1.5px solid var(--primary); padding: 14px 20px !important; border-radius: 100px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; transition: all 0.3s ease; display: inline-block; text-align: center; width: 100%; }
        .btn-ghost-sm:hover { background-color: #DEE9FA; border-color: #DEE9FA; }
        .btn-secure-portal { background-color: #2E4982; color: white; width: 100%; padding: 18px !important; border-radius: 14px; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 10px 20px -5px rgba(46, 73, 130, 0.2); text-align: center; }
        .profile-line { @apply border-b border-slate-50 py-7 last:border-0; }
        .profile-label-text { @apply text-[10px] font-extrabold text-slate-400 uppercase tracking-[0.3em] block mb-2; }
        .profile-value-text { @apply text-[14px] text-slate-500 font-medium leading-relaxed; }
        .input-apple { width: 100%; padding: 18px 22px !important; border: 1.5px solid #E5E7EB !important; border-radius: 18px; background-color: #FFFFFF; outline: none; font-size: 15px; transition: all 0.3s ease; }
        .input-apple:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 4px #DEE9FA; }
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .mix-blend-multiply { mix-blend-mode: multiply; }
        #specialist-panel { background: #2E4982; border-bottom: 2px solid #1e315a; position: sticky; top: 0; z-index: 500; color: white; padding: 10px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .spec-select { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 10px; font-weight: 700; padding: 6px 12px; outline: none; color: white; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; }
        .spec-select option { color: #333; }
        /* APPLE INTELLIGENCE GLOW EFFECT */
        @keyframes ai-breathing {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.2), 0 0 40px rgba(59, 130, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.4), 0 0 60px rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); }
        }
        .ai-card-glow { animation: ai-breathing 4s infinite ease-in-out; background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-[#DEE9FA] selection:text-[#2E4982]">

    <div class="bg-mesh"></div>
    
    <!-- PANEL MAESTRO ESPECIALISTA -->
    <div id="specialist-panel" class="hidden">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-3">
            <div class="flex items-center gap-3 overflow-x-auto pb-1 md:pb-0">
                <span class="text-[9px] font-black uppercase tracking-[0.2em] shrink-0">Admin:</span>
                <select class="spec-select" onchange="window.updateSpecMode(this.value)">
                    <option value="sin_programa">Vista Paciente (Default)</option>
                    <option value="quema_grasa">Vista Quema Grasa</option>
                    <option value="sano">Vista SANO</option>
                    <option value="adios_diabetes">Vista Adi√≥s Diabetes</option>
                </select>
                <button onclick="window.openAdminTraining()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all flex items-center gap-2">
                    <span>üß† Entrenar IA</span>
                </button>
            </div>
            <p class="hidden md:block text-[9px] opacity-60 italic">Panel de Control</p>
        </div>
    </div>

    <!-- VISTA DE ENTRENAMIENTO ADMIN -->
    <section id="admin-training-view" class="min-h-screen hidden bg-slate-50 text-left">
        <header class="bg-white border-b h-20 flex items-center px-6 justify-between sticky top-0 z-50">
            <button onclick="window.showView('patient-view')" class="text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg> Volver
            </button>
            <h2 class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em]">Configuraci√≥n IA</h2>
            <div class="w-10"></div>
        </header>
        <main class="max-w-3xl mx-auto py-10 px-6">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                <h3 class="text-xl font-bold text-[#2E4982] mb-2">Instrucciones del Sistema (System Prompt)</h3>
                <p class="text-sm text-slate-500 mb-6">Define aqu√≠ c√≥mo debe comportarse la IA. Estos cambios afectar√°n a todos los pacientes.</p>
                <textarea id="admin-prompt-input" class="w-full h-96 p-5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-mono text-slate-700 focus:border-[#2E4982] focus:ring-2 focus:ring-blue-50 outline-none resize-none leading-relaxed" placeholder="Escribe aqu√≠ las instrucciones..."></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button onclick="window.showView('patient-view')" class="px-6 py-3 rounded-xl text-xs font-bold text-slate-500 hover:bg-slate-50 uppercase tracking-widest">Cancelar</button>
                    <button onclick="window.saveSystemPrompt()" class="bg-[#2E4982] text-white px-8 py-3 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg hover:bg-[#1e315a] transition-colors">Guardar Cambios</button>
                </div>
            </div>
        </main>
    </section>

    <!-- M√ìVIL CHAT VIEW (SE COMPORTA COMO OTRA P√ÅGINA) -->
    <section id="mobile-ai-view" class="h-[100dvh] hidden bg-[#FBFBFC] text-left flex flex-col fixed inset-0 z-[2000]">
        <header class="h-24 flex items-center px-6 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 shrink-0">
            <button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button>
            <div class="flex flex-col items-center">
                <span class="text-[10px] font-bold text-[#2E4982] uppercase tracking-[0.3em]">Asistente</span>
                <div class="flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    <span class="text-[10px] font-medium text-emerald-600 uppercase tracking-wider">En l√≠nea</span>
                </div>
            </div>
            <div class="w-10"></div>
        </header>
        
        <div id="ai-messages-mobile" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
            <div class="flex justify-center mb-8">
                <p class="text-xs text-slate-400 font-medium uppercase tracking-widest">Hoy</p>
            </div>
            <div class="flex justify-start fade-in">
                <div id="ai-welcome-text-mobile" class="max-w-[90%] bg-white border border-slate-100 px-6 py-4 rounded-[1.5rem] rounded-tl-sm text-[15px] leading-relaxed text-slate-600 shadow-sm">
                    Hola, soy tu asistente personal.
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-slate-50 shrink-0">
            <form onsubmit="event.preventDefault(); window.sendMessageToAI('mobile')" class="relative flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-[1.5rem] px-2 py-2 shadow-inner focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                <input id="ai-input-mobile" type="text" placeholder="Escribe tu consulta..." class="flex-1 bg-transparent border-none outline-none px-4 py-3 text-slate-700 placeholder:text-slate-400 text-[15px]">
                <button type="submit" class="w-12 h-12 bg-[#2E4982] text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </form>
        </div>
    </section>

    <!-- DESKTOP MODAL (ESTILO SPOTLIGHT) - SOLO VISIBLE EN PANTALLAS GRANDES -->
    <div id="ai-modal-overlay" class="fixed inset-0 z-[2000] bg-white/30 backdrop-blur-xl hidden opacity-0 transition-opacity duration-300 items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl h-[70vh] rounded-[2.5rem] shadow-2xl border border-white/60 flex flex-col overflow-hidden scale-95 opacity-0 transition-all duration-300 relative pointer-events-auto">
            <!-- Header Modal -->
            <div class="h-16 flex items-center justify-between px-8 border-b border-slate-50 shrink-0 bg-white/80 backdrop-blur-md z-10">
                <div class="flex flex-col">
                    <span class="font-bold text-sm text-slate-800">Asistente IMNUFIT</span>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <span class="relative flex h-1.5 w-1.5">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span>
                        </span>
                        <span class="text-[9px] font-bold text-emerald-600 uppercase tracking-widest">En l√≠nea</span>
                    </div>
                </div>
                <button onclick="window.closeDesktopAIModal()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-colors">
                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l18 18"></path></svg>
                </button>
            </div>

            <!-- Chat Area -->
            <div id="ai-messages-desktop" class="flex-1 overflow-y-auto p-8 space-y-6 scroll-smooth bg-[#FBFBFC]">
                <div class="flex justify-center mb-8">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-widest">Hoy</p>
                </div>
                <div class="flex justify-start fade-in">
                    <div id="ai-welcome-text-desktop" class="max-w-[85%] bg-white border border-slate-100 px-6 py-4 rounded-[1.5rem] rounded-tl-sm text-[15px] leading-relaxed text-slate-600 shadow-sm">
                        Hola, soy tu asistente personal.
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 bg-white shrink-0">
                <form onsubmit="event.preventDefault(); window.sendMessageToAI('desktop')" class="relative flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-[1.5rem] px-2 py-2 shadow-inner focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                    <input id="ai-input-desktop" type="text" placeholder="Preg√∫ntame sobre recetas, ayuno o tu progreso..." class="flex-1 bg-transparent border-none outline-none px-4 py-3 text-slate-700 placeholder:text-slate-400 text-[15px]">
                    <button type="submit" class="w-12 h-12 bg-[#2E4982] hover:bg-[#1e315a] text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-900/10 transition-transform active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="notification-toast" class="hidden fixed top-8 left-1/2 -translate-x-1/2 z-[800] px-8 py-4 rounded-full shadow-2xl text-[13px] font-semibold bg-white border">
        <span id="notification-content"></span>
    </div>
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="h-8 w-8 border-[3px] border-[#2E4982] border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- DASHBOARD -->
    <section id="patient-view" class="min-h-screen hidden text-left">
        <header class="bg-white/40 backdrop-blur-xl border-b h-24 flex items-center px-8 justify-between sticky top-0 z-40 text-left">
            <button onclick="window.showView('patient-view')" class="hover:opacity-80 transition-opacity">
                <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="h-10 object-contain mix-blend-multiply">
            </button>
            <div class="flex items-center gap-3">
                <a href="https://imnufit.com" target="_blank" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group" title="Ir a web"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg></a>
                <button onclick="window.refreshData()" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group" title="Actualizar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                <button onclick="window.showView('contact-view')" class="text-slate-600 hover:text-[#2E4982] p-2 transition-colors group" title="Contacto"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
                <button onclick="window.showView('membership-view')" class="w-10 h-10 rounded-full bg-[#DEE9FA] flex items-center justify-center text-[#2E4982] hover:bg-[#2E4982] hover:text-white transition-all shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
                <button onclick="window.cerrarSesion()" class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest hover:text-red-500 ml-2">Salir</button>
            </div>
        </header>

        <main class="max-w-5xl mx-auto py-12 px-6 space-y-12">
            <div class="space-y-6 text-left">
                <div>
                    <p id="display-greeting" class="text-[10px] font-bold text-[#2E4982] uppercase tracking-[0.5em] mb-1 flex items-center"></p>
                    <h2 class="text-2xl font-bold tracking-tight text-[#494949] leading-tight text-left"><span id="display-nombre">...</span></h2>
                    <div class="pt-2 text-left"><span id="display-estatus" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase border inline-block text-left">Cargando...</span></div>
                </div>
                <div class="bg-white/60 p-6 rounded-[2rem] border border-white/60 shadow-sm backdrop-blur-md max-w-3xl text-slate-600 text-left"><p id="display-frase" class="italic text-[15px] leading-relaxed">...</p></div>
                
                <div id="featured-plan-banner" class="hidden fade-in text-left">
                    <div class="bg-[#2E4982] rounded-[2.5rem] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden group cursor-pointer" onclick="window.viewProgramResources()">
                        <div class="absolute -right-16 -top-16 w-64 h-64 bg-white/10 rounded-full blur-3xl text-left"></div>
                        <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-8 text-left">
                            <div class="space-y-3 text-left">
                                <span class="text-[10px] font-bold uppercase tracking-[0.4em] opacity-60 text-left">Tu Programa Asignado</span>
                                <h3 id="plan-banner-title" class="text-xl md:text-2xl font-bold tracking-tight text-left">...</h3>
                                <p class="text-white/50 text-sm max-w-sm italic font-medium leading-relaxed text-left">Accede a tus recursos exclusivos acumulados.</p>
                            </div>
                            <button class="bg-white text-[#2E4982] px-8 py-4 rounded-full text-[11px] font-extrabold uppercase tracking-widest shadow-xl group-hover:scale-105 transition-transform shrink-0">Ver Recursos</button>
                        </div>
                    </div>
                </div>

                <div id="restricted-banner" class="hidden fade-in text-left">
                    <div class="bg-[#2E4982] rounded-[2.5rem] p-10 md:p-12 text-white shadow-2xl relative overflow-hidden text-center flex flex-col items-center">
                        <div class="absolute -right-16 -top-16 w-64 h-64 bg-white/10 rounded-full blur-3xl text-left"></div>
                        <div class="relative z-10 space-y-4 max-w-xl text-center">
                            <span id="restricted-banner-title" class="text-[10px] font-bold uppercase tracking-[0.4em] opacity-60 text-center">Portal de Seguimiento</span>
                            <h3 class="text-xl md:text-2xl font-bold tracking-tight text-center text-white">Tu Salud es Prioridad</h3>
                            <p id="restricted-banner-body" class="text-white/70 text-[14px] font-medium leading-relaxed text-center"></p>
                            <div id="restricted-btn-container" class="w-full text-center"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <!-- TARJETA IA REDISE√ëADA (ESTILO APPLE INTELLIGENCE) -->
                <section id="card-ai" class="ai-card-glow rounded-[2.5rem] p-8 border border-white/50 relative overflow-hidden cursor-pointer group transition-transform hover:-translate-y-1" onclick="window.openAIChat()">
                    <div class="relative z-10 flex flex-col justify-between h-full min-h-[220px]">
                        <div class="flex items-start justify-between">
                            <div>
                                <span class="px-3 py-1 bg-white/50 backdrop-blur-md rounded-full text-[10px] font-extrabold text-[#2E4982] uppercase tracking-[0.2em] border border-white/60">Nuevo</span>
                                <h3 class="text-2xl font-bold text-slate-800 mt-3 leading-tight">Asistente<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-600 to-blue-500">Inteligente</span></h3>
                            </div>
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-violet-100 to-blue-50 flex items-center justify-center text-blue-600 shadow-sm">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <p class="text-[14px] text-slate-500 font-medium leading-relaxed">"¬øQu√© puedo comer si tengo antojo de dulce?"</p>
                            <div class="flex items-center gap-2 text-xs font-bold text-[#2E4982] group-hover:gap-3 transition-all">
                                <span>Iniciar conversaci√≥n</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -bottom-10 -right-10 w-48 h-48 bg-gradient-to-tr from-blue-200 to-violet-200 rounded-full blur-[60px] opacity-60 pointer-events-none"></div>
                </section>

                <section id="card-entrenamientos" class="bento-card min-h-[300px]">
                    <div class="w-14 h-14 bg-[#DEE9FA] rounded-2xl flex items-center justify-center mb-6 shrink-0"><img src="https://imnufit.com/wp-content/uploads/2022/01/iuiuo.png" class="w-11 h-11 object-contain text-left"></div>
                    <div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1">Entrenaconfren+</h4><h3 class="text-2xl font-bold text-[#494949]">Entrenamientos</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Accede a tus rutinas y gu√≠as.</p></div>
                    <div class="mt-8 text-center"><a href="https://imnufit.com/entrenaconfrenplus/" target="_blank" class="btn-ghost-sm">Ir a Entrenar</a></div>
                </section>
                <section id="card-reporte" class="bento-card min-h-[300px]">
                    <div class="w-14 h-14 bg-[#FFEDD5] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-left"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1">Seguimiento</h4><h3 class="text-2xl font-bold text-[#494949]">Reporte Mensual</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Registra tus progresos.</p></div>
                    <div class="mt-8 text-center"><a href="https://airtable.com/appCHcm7XPzeoyBCs/pagh79fwniuSPmusB/form" target="_blank" class="btn-ghost-sm">Llenar Reporte</a></div>
                </section>
                <section id="card-citas" class="bento-card min-h-[300px]">
                    <div class="w-14 h-14 bg-[#D0F0E0] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-left"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                    <div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Citas</h4><h3 class="text-2xl font-bold text-[#494949]">Reservar Consulta</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Gestiona tu espacio aqu√≠.</p></div>
                    <div id="calendar-action-container" class="mt-8 text-center w-full"></div>
                </section>
                <section id="card-consultas" class="bento-card min-h-[300px]">
                    <div class="w-14 h-14 bg-[#E7E3FB] rounded-2xl flex items-center justify-center mb-6 text-[#2E4982] shrink-0 text-left"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <div class="text-left"><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1 text-left">Registro</h4><h3 class="text-2xl font-bold text-[#494949]">Consultas Recientes</h3><p class="text-[14px] text-slate-500 mt-2 leading-relaxed text-left">Historial de evaluaciones.</p></div>
                    <div class="mt-8 text-center"><a id="btn-consultas-action" href="#" target="_blank" class="btn-ghost-sm">Abrir Historial</a></div>
                </section>
            </div>
        </main>
    </section>

    <!-- PROGRAM DETAIL -->
    <section id="program-detail-view" class="min-h-screen hidden bg-[#FBFBFC] text-left">
        <header class="h-24 flex items-center px-4 md:px-8 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 text-left">
            <button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors group text-left flex-shrink-0"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button>
            <span class="text-[10px] md:text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-center flex-1 mx-2">Recursos del Programa</span>
            <div class="w-10 hidden md:block"></div>
        </header>
        <main class="max-w-xl mx-auto py-16 px-6 fade-in space-y-12 flex flex-col items-center text-center">
            <div id="program-img-container" class="flex justify-center"><img id="program-img-main" src="" class="object-contain mix-blend-multiply text-center"></div>
            <div class="w-full space-y-8 text-center">
                <div class="space-y-2 text-center">
                    <p class="text-[#2E4982] text-[9px] font-extrabold uppercase tracking-[0.5em] text-center">Material Oficial</p>
                    <h3 class="text-2xl font-bold text-slate-800 text-center">Recursos de tu Tratamiento</h3>
                </div>
                <div id="program-guias-list" class="grid gap-5 w-full text-left"></div>
            </div>
            <p class="text-slate-300 text-[10px] font-medium italic text-center">¬© IMNUFIT ‚Äî Nutrici√≥n con Prop√≥sito</p>
        </main>
    </section>

    <!-- CONTACT VIEW -->
    <section id="contact-view" class="min-h-screen hidden bg-white text-left">
        <header class="h-24 flex items-center px-8 border-b border-slate-50 justify-between sticky top-0 bg-white z-50 text-left">
            <button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors text-left"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button>
            <span class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-left">Contacto</span><div class="w-10"></div>
        </header>
        <main class="max-w-xl mx-auto py-16 px-6 fade-in space-y-12 text-left">
            <div class="text-center space-y-4 text-left">
                <h3 class="text-2xl font-bold text-slate-800 tracking-tight text-left">Atenci√≥n al Paciente</h3>
                <p class="text-slate-500 text-sm text-left">Estamos aqu√≠ para apoyarte en tu camino.</p>
            </div>
            <div class="bg-[#2E4982] rounded-[2.5rem] p-8 md:p-10 text-white shadow-xl space-y-8 relative overflow-hidden text-left">
                <div class="absolute -right-16 -top-16 w-48 h-48 bg-white/5 rounded-full blur-2xl text-left"></div>
                <div class="flex items-center gap-5 text-left">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center shrink-0 text-left"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.246 2.248 3.484 5.232 3.483 8.413-.003 6.557-5.338 11.892-11.893 11.892-1.997-.001-3.951-.5-5.688-1.448l-6.308 1.655zm6.205-4.105l.345.205c1.332.793 2.839 1.211 4.382 1.212 4.793 0 8.694-3.901 8.697-8.694 0-2.324-.904-4.509-2.547-6.152-1.642-1.642-3.827-2.547-6.15-2.547-4.796 0-8.696 3.901-8.699 8.694 0 1.646.463 3.253 1.339 4.653l.225.362-.977 3.564 3.65-.958z"/></svg></div>
                    <div class="text-left"><h4 class="font-bold text-xl">Soporte WhatsApp</h4><p class="text-white/60 text-xs font-black uppercase tracking-widest mt-1 text-left">Chat directo</p></div>
                </div>
                <div class="space-y-4 bg-white/10 p-6 rounded-3xl backdrop-blur-sm border border-white/5 text-left">
                    <p class="text-[10px] font-black uppercase tracking-[0.3em] text-white/50 text-left">Horario de Atenci√≥n (EE.UU. Este)</p>
                    <div class="grid grid-cols-1 gap-3 text-left">
                        <div class="flex justify-between items-center text-sm font-semibold text-left"><span>Lunes - Viernes</span><span class="opacity-90 text-left">10:00 am - 6:00 pm</span></div>
                        <div class="flex justify-between items-center text-[10px] uppercase font-black tracking-widest text-white/40 pt-2 border-t border-white/5 text-left"><span>S√°bados - Domingos</span><span class="italic text-left">Cerrado</span></div>
                    </div>
                </div>
                <a href="https://wa.me/14076325438" target="_blank" class="block w-full bg-white text-[#2E4982] py-5 rounded-full text-[11px] font-black uppercase tracking-widest text-center shadow-lg hover:scale-[1.02] transition-transform text-center">Iniciar Chat</a>
            </div>
            <div class="grid gap-4 text-left">
                <p class="text-slate-300 text-[10px] font-black uppercase tracking-[0.5em] text-center text-left">Nuestras Redes</p>
                <div class="grid gap-3 text-left">
                    <a href="https://www.instagram.com/imnufit/" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">IG</span><span class="text-sm font-bold text-slate-700 text-left">Instagram</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                    <a href="https://www.youtube.com/@entrenaconfren" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">YT</span><span class="text-sm font-bold text-slate-700 text-left">YouTube</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                    <a href="https://www.facebook.com/entrenaconfren" target="_blank" class="flex items-center justify-between p-5 rounded-3xl bg-slate-50 border border-slate-100 hover:bg-[#DEE9FA]/50 transition-all group text-left">
                        <div class="flex items-center gap-4 text-left"><span class="w-10 h-10 rounded-xl bg-white flex items-center justify-center text-slate-400 shadow-sm font-bold text-xs italic text-left">FB</span><span class="text-sm font-bold text-slate-700 text-left">Facebook</span></div>
                        <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                </div>
            </div>
            <div class="pt-8 border-t border-slate-50 text-center"><a href="mailto:imnufit@gmail.com" class="inline-block space-y-1 text-left"><p class="text-slate-300 text-[9px] font-black uppercase tracking-[0.4em] text-left">Email Oficial</p><p class="text-slate-600 font-bold text-sm hover:text-[#2E4982] transition-colors text-left">imnufit@gmail.com</p></a></div>
        </main>
    </section>

    <!-- MI CUENTA -->
    <section id="membership-view" class="min-h-screen hidden bg-slate-50/50 pb-20 text-left">
        <header class="bg-white/40 backdrop-blur-xl border-b h-24 flex items-center px-8 justify-between sticky top-0 z-40 text-left">
            <button onclick="window.showView('patient-view')" class="flex items-center gap-2 text-slate-400 hover:text-[#2E4982] font-bold text-xs uppercase tracking-widest transition-colors text-left"><svg class="w-4 h-4 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M15 19l-7-7 7-7"></path></svg> Volver</button>
            <h2 class="text-sm font-bold text-[#494949] uppercase tracking-[0.2em] text-left">Mi Cuenta</h2><div class="w-10"></div>
        </header>
        <main class="max-w-2xl mx-auto py-12 px-6 space-y-10 text-left">
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left">
                <div class="flex items-center gap-4 mb-12 text-left"><div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-[#2E4982] shadow-sm text-left"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div><div><h3 class="text-xl font-bold text-[#494949]">Perfil Personal</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Identidad en Consulta</p></div></div>
                <div class="space-y-0 text-left">
                    <div class="profile-line text-left"><span class="profile-label-text">Paciente:</span><span id="acc-nombre" class="profile-value-text text-slate-500">...</span></div>
                    <div class="profile-line flex items-center justify-start !py-6 text-left"><span id="acc-genero">--</span></div>
                    <div class="profile-line text-left"><span class="profile-label-text">Nacimiento:</span><span id="acc-nacimiento" class="profile-value-text text-slate-500">--</span></div>
                    <div class="profile-line text-left"><span class="profile-label-text">Pa√≠s:</span><span id="acc-pais" class="profile-value-text text-slate-500">--</span></div>
                    <div class="profile-line border-0 text-left"><span class="profile-label-text">Tel√©fono:</span><span id="acc-telefono" class="profile-value-text text-slate-500">--</span></div>
                    <div class="mt-4 pt-10 border-t border-slate-50 text-left">
                        <span class="profile-label-text !mb-1 text-left">Email de acceso</span>
                        <div class="h-1 text-left"></div>
                        <span id="acc-email" class="text-[14px] font-medium text-slate-500">--</span>
                    </div>
                </div>
            </section>
            
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left"><div class="flex items-center gap-4 mb-8 text-left"><div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-500 shadow-sm text-left"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M12 15v2m-6 4h12a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div><div class="text-left"><h3 class="text-xl font-bold text-[#494949]">Seguridad</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Cambio de Acceso</p></div></div><form onsubmit="window.updateAppPassword(event)" class="space-y-6 text-left"><div><label class="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1 text-left">Nueva Contrase√±a</label><input type="password" name="newPassword" required minlength="6" class="input-apple mt-2 text-left"></div><button type="submit" class="btn-ingresar !bg-slate-800 text-center">Actualizar Contrase√±a</button></form></section>
            
            <section class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-50 text-left">
                <div class="flex items-center gap-4 mb-8 text-left">
                    <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm text-left"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg></div>
                    <div class="text-left"><h3 class="text-xl font-bold text-[#494949]">Membres√≠a</h3><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest text-left">Gesti√≥n de Suscripci√≥n</p></div>
                </div>
                <p class="text-[14px] text-slate-500 mb-8 leading-relaxed text-left">Utilizamos una plataforma segura para tus suscripciones. Desde aqu√≠ podr√°s actualizar tu tarjeta o <strong>cancelar tu membres√≠a</strong>.</p>
                <div class="flex justify-center text-center">
                    <a href="https://billing.stripe.com/p/login/bIY9CF3un99T2XefYY" target="_blank" class="btn-secure-portal px-12 text-center">Gestionar Membres√≠a y Pagos <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>
                </div>
            </section>
            <button onclick="window.cerrarSesion()" class="w-full py-4 text-xs font-bold text-red-400 uppercase tracking-widest hover:text-red-600 transition-colors text-center">Cerrar Sesi√≥n</button>
        </main>
    </section>

    <!-- LOGIN -->
    <section id="login-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-[340px] w-full space-y-12 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply text-center">
            <div class="space-y-2 text-center">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949]">Portal del Paciente</h1>
                <p class="text-[14px] text-slate-500 text-center">Inicia sesi√≥n para continuar</p>
            </div>
            <form onsubmit="window.handleLogin(event)" class="space-y-6 text-center">
                <input type="email" name="email" required placeholder="Correo electr√≥nico" class="input-apple text-center">
                <div class="space-y-3 text-center">
                    <input type="password" name="pass" required placeholder="Contrase√±a" class="input-apple text-center">
                    <div class="text-center"><button type="button" onclick="window.showView('forgot-password-view')" class="text-[11px] font-bold text-[#2E4982] uppercase tracking-widest hover:underline text-center">¬øOlvidaste tu contrase√±a?</button></div>
                </div>
                <div class="space-y-5 text-center">
                    <button type="submit" class="btn-ingresar">Entrar al portal</button>
                    <button type="button" onclick="window.showView('signup-view')" class="text-[12px] font-extrabold text-[#2E4982] uppercase tracking-tight text-center">
                        ¬øEres nuevo? <span class="border-b border-[#2E4982]/30 pb-0.5">Crea tu cuenta aqu√≠</span>
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- FORGOT PASSWORD -->
    <section id="forgot-password-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-[340px] w-full space-y-10 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply">
            <div class="space-y-2 text-center">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949] text-center">Recuperar Acceso</h1>
                <p class="text-[14px] text-slate-500 text-center">Te enviaremos un enlace a tu correo</p>
            </div>
            <form onsubmit="window.handlePasswordReset(event)" class="space-y-6 text-center">
                <input type="email" name="resetEmail" required placeholder="Correo de acceso" class="input-apple text-center">
                <button type="submit" class="btn-ingresar">Enviar enlace</button>
                <p class="text-[12px] text-slate-700 font-bold text-center">üí° Si no recibes el correo, revisa tu carpeta de <span class="text-slate-800 underline">Spam</span>.</p>
            </form>
            <button onclick="window.showView('login-view')" class="text-[12px] font-bold text-[#2E4982] uppercase tracking-widest w-full text-center">Volver al inicio</button>
        </div>
    </section>

    <!-- SIGNUP -->
    <section id="signup-view" class="min-h-screen hidden flex flex-col items-center justify-center p-8 text-center">
        <div class="max-w-[340px] w-full space-y-12 fade-in text-center text-left">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain mix-blend-multiply text-center">
            <div class="space-y-2 text-center">
                <h1 class="text-2xl font-bold tracking-tight text-[#494949] text-center">Crear tu cuenta</h1>
                <p class="text-[14px] text-slate-500 text-center">Usa el correo registrado en consulta</p>
            </div>
            <form onsubmit="window.handleSignup(event)" class="space-y-6 text-center">
                <input type="email" name="email" required placeholder="Correo electr√≥nico" class="input-apple text-center">
                <input type="password" name="pass" required minlength="6" placeholder="Contrase√±a" class="input-apple text-center">
                <input type="password" name="confirmPass" required minlength="6" placeholder="Confirmar contrase√±a" class="input-apple text-center">
                <button type="submit" class="btn-ingresar mt-4 text-center">Registrarme</button>
            </form>
            <button onclick="window.showView('login-view')" class="text-[11px] font-bold text-[#2E4982] uppercase tracking-widest hover:underline text-center">¬øYa tienes cuenta? Inicia sesi√≥n</button>
        </div>
    </section>

</body>
</html>
