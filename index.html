<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMNUFIT - Portal del Paciente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 1. CONFIGURACIÃ“N DE FIREBASE (AutenticaciÃ³n) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJBf7TbP1GuAoA3GsrCG0EJOifEt4YodY",
            authDomain: "imnufit-cad14.firebaseapp.com",
            projectId: "imnufit-cad14",
            storageBucket: "imnufit-cad14.firebasestorage.app",
            messagingSenderId: "65610345018",
            appId: "1:65610345018:web:eac15a30c72084faac6303"
        };

        // --- 2. CONFIGURACIÃ“N DE AIRTABLE (Base de Datos Principal) ---
        // Â¡IMPORTANTE! Reemplaza los valores dentro de las comillas con tus datos reales
        const AIRTABLE_PAT = "patZ9QUQVyldn9zKC.afb4fc362eb2f79b1aa10faf3fb3268ea6bca3f57a1362b83f6cc8459a50f0d3"; 
        const AIRTABLE_BASE_ID = "appCHcm7XPzeoyBCs"; 
        const AIRTABLE_TABLE_NAME = "Pacientes"; // AsegÃºrate de que tu tabla en Airtable se llame asÃ­

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Frases motivacionales
        const frasesCreyentes = [
            "Todo lo puedo en Cristo que me fortalece. â€” Filipenses 4:13",
            "Pon en manos del SeÃ±or todas tus obras, y tus proyectos se cumplirÃ¡n. â€” Proverbios 16:3",
            "El SeÃ±or es mi pastor; nada me falta. â€” Salmo 23:1",
            "No te canses de hacer el bien, porque a su debido tiempo cosecharÃ¡s. â€” GÃ¡latas 6:9",
            "ConfÃ­a en el SeÃ±or de todo corazÃ³n. â€” Proverbios 3:5",
            "Â¡SÃ© fuerte y valiente! No tengas miedo ni te desanimes. â€” JosuÃ© 1:9",
            "Su amor es constante y nuevo cada maÃ±ana. â€” Lamentaciones 3:22"
        ];

        setPersistence(auth, browserLocalPersistence);

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Buenos dÃ­as";
            if (hour < 18) return "Buenas tardes";
            return "Buenas noches";
        }

        // Sistema de Notificaciones Toast
        window.notify = (message, type = 'error') => {
            const toast = document.getElementById('notification-toast');
            const content = document.getElementById('notification-content');
            
            if (content) {
                content.textContent = message;
                toast.className = `fixed top-8 left-1/2 -translate-x-1/2 z-[200] px-8 py-4 rounded-full shadow-2xl text-[13px] font-semibold transition-all duration-500 scale-100 opacity-100 backdrop-blur-xl ${
                    type === 'success' ? 'bg-white/90 text-emerald-600 border border-emerald-100' : 'bg-white/90 text-red-600 border border-red-100'
                }`;
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => toast.classList.add('hidden'), 4000);
                }, 3000);
            } else {
                console.log("NotificaciÃ³n:", message);
            }
        };

        // FunciÃ³n para obtener datos de Airtable con DiagnÃ³stico
        async function fetchAirtableData(email) {
            console.log("ðŸ”„ Iniciando conexiÃ³n a Airtable para:", email);
            
            if (!AIRTABLE_PAT || !AIRTABLE_BASE_ID) {
                console.error("âŒ Error: Faltan credenciales de Airtable en el cÃ³digo.");
                return null;
            }
            
            // FÃ³rmula para filtrar por email
            const formula = encodeURIComponent(`({Email}='${email}')`);
            const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${formula}`;
            
            try {
                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${AIRTABLE_PAT}` }
                });
                
                if (!response.ok) {
                    console.error("âŒ Error de red Airtable:", response.status, response.statusText);
                    throw new Error("Error de conexiÃ³n con Airtable");
                }
                
                const data = await response.json();
                console.log("ðŸ“¡ Respuesta bruta de Airtable:", data);

                if (data.records.length > 0) {
                    console.log("âœ… Â¡Ã‰XITO! Paciente encontrado:", data.records[0].fields);
                    return data.records[0].fields;
                } else {
                    console.warn("âš ï¸ ConexiÃ³n exitosa, pero NO se encontrÃ³ ningÃºn registro con el email:", email);
                    return null;
                }
            } catch (error) {
                console.error("âŒ Error crÃ­tico:", error);
                return null;
            }
        }

        function showView(viewId) {
            const views = ['login-view', 'signup-view', 'patient-view', 'loading-screen', 'consultas-view'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('hidden', id !== viewId);
            });
            window.scrollTo(0,0);
        }

        // --- CONTROLADOR DE SESIÃ“N ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // 1. Obtener datos de Airtable
                const airtableData = await fetchAirtableData(user.email);
                
                if (airtableData) {
                    // 2. Rellenar la UI con datos reales
                    // CAMBIO: Ahora busca la columna "Nombre + Edad"
                    document.getElementById('display-nombre').textContent = airtableData["Nombre + Edad"] || airtableData["Nombre"] || "Paciente";
                    document.getElementById('display-greeting').textContent = getGreeting();
                    
                    // Cita y Links
                    const proximaCita = airtableData["Proxima Cita"] || "Pendiente de asignar";
                    document.getElementById('display-proxima-cita').textContent = proximaCita;
                    
                    const linkCalendar = airtableData["Link Calendar"] || "https://calendar.app.google/CE4KjKxPeFiV93GV7";
                    const linkHistorial = airtableData["Link Historial"] || "#";
                    
                    // Asignar links a botones
                    document.getElementById('btn-calendar-action').href = linkCalendar;
                    
                    const btnHistorial = document.getElementById('btn-historial-action');
                    btnHistorial.href = linkHistorial;
                    
                    if(linkHistorial === "#" || !linkHistorial) {
                       btnHistorial.style.opacity = "0.5";
                       btnHistorial.style.cursor = "not-allowed";
                       btnHistorial.onclick = (e) => { e.preventDefault(); notify("Tu historial clÃ­nico aÃºn no estÃ¡ vinculado."); };
                    } else {
                        btnHistorial.onclick = null;
                        btnHistorial.target = "_blank";
                        btnHistorial.style.opacity = "1";
                        btnHistorial.style.cursor = "pointer";
                    }

                    // Frase aleatoria
                    const randomFrase = frasesCreyentes[Math.floor(Math.random() * frasesCreyentes.length)];
                    document.getElementById('display-frase').textContent = randomFrase;

                    showView('patient-view');
                } else {
                    notify("ConexiÃ³n establecida, pero tu email no aparece en la tabla de Airtable.", "error");
                    document.getElementById('display-nombre').textContent = user.email.split('@')[0];
                    document.getElementById('display-proxima-cita').textContent = "---";
                    showView('patient-view');
                }
            } else {
                showView('login-view');
            }
            document.getElementById('loading-screen').classList.add('hidden');
        });

        // --- EVENTOS LOGIN/REGISTRO ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const { email, pass } = e.target;
            try {
                document.getElementById('loading-screen').classList.remove('hidden');
                await signInWithEmailAndPassword(auth, email.value, pass.value);
            } catch (err) {
                notify("Credenciales incorrectas.");
                document.getElementById('loading-screen').classList.add('hidden');
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();
            const { email, pass } = e.target;
            try {
                document.getElementById('loading-screen').classList.remove('hidden');
                await createUserWithEmailAndPassword(auth, email.value, pass.value);
                notify("Cuenta de acceso creada. Esperando datos clÃ­nicos...", "success");
            } catch (err) { notify("Error al crear cuenta."); document.getElementById('loading-screen').classList.add('hidden'); }
        };

        window.cerrarSesion = () => signOut(auth);
        window.toggleView = (id) => showView(id);

    </script>
    <style>
        :root { --primary: #2E4982; --apple-bg: #FBFBFC; }
        body { font-family: 'Inter', sans-serif; background-color: var(--apple-bg); color: #1D1D1F; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        
        .bg-mesh {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 80% 20%, rgba(46, 73, 130, 0.04) 0%, transparent 40%),
                        radial-gradient(circle at 20% 80%, rgba(46, 73, 130, 0.03) 0%, transparent 40%);
        }

        .input-apple { 
            width: 100%; padding: 18px 22px !important; border: 1.5px solid #E5E7EB !important; border-radius: 18px;
            background-color: #FFFFFF; outline: none; font-size: 15px; transition: all 0.3s ease;
        }
        .input-apple:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 4px rgba(46, 73, 130, 0.04); }

        .btn-ingresar {
            background-color: var(--primary); color: #FFFFFF; width: 100%; padding: 20px !important; border-radius: 100px;
            font-weight: 600; font-size: 15px; letter-spacing: 0.02em; border: none; transition: all 0.4s ease;
            box-shadow: 0 10px 20px -5px rgba(46, 73, 130, 0.2); cursor: pointer;
        }
        .btn-ingresar:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(46, 73, 130, 0.3); }

        /* Estilo Bento Grid */
        .bento-card {
            @apply bg-white/80 backdrop-blur-xl border border-white/60 transition-all duration-500 flex flex-col justify-between;
            border-radius: 40px;
            padding: 36px 32px !important; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.02);
        }
        .bento-card:hover { transform: translateY(-4px); box-shadow: 0 20px 50px -10px rgba(0,0,0,0.04); }

        /* BotÃ³n Ghost Premium */
        .btn-ghost-sm {
            background-color: transparent; color: var(--primary); border: 1.5px solid var(--primary);
            padding: 14px 48px !important; border-radius: 100px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.12em; transition: all 0.3s ease;
            display: inline-block; text-align: center; cursor: pointer; text-decoration: none;
        }
        .btn-ghost-sm:hover { background-color: var(--primary); color: #FFFFFF; }

        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="selection:bg-[#2E4982]/10">

    <div class="bg-mesh"></div>

    <!-- NOTIFICACIÃ“N (Corregido) -->
    <div id="notification-toast" class="hidden">
        <span id="notification-content"></span>
    </div>
    
    <div id="loading-screen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="h-8 w-8 border-[3px] border-[#2E4982] border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- VISTA 1: LOGIN -->
    <section id="login-view" class="min-h-screen flex flex-col items-center justify-center p-8 hidden">
        <div class="max-w-[340px] w-full space-y-12 fade-in text-center">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="mx-auto h-11 object-contain">
            <div class="space-y-2">
                <h1 class="text-2xl font-bold tracking-tight text-slate-800">Acceso Pacientes</h1>
                <p class="text-[14px] text-slate-500">Inicia sesiÃ³n para acceder a tu cuenta.</p>
            </div>
            <form onsubmit="window.handleLogin(event)" class="space-y-8">
                <div class="space-y-4">
                    <input type="email" name="email" required placeholder="Correo electrÃ³nico" class="input-apple">
                    <input type="password" name="pass" required placeholder="ContraseÃ±a" class="input-apple">
                </div>
                <button type="submit" class="btn-ingresar">Entrar al portal</button>
            </form>
            <button onclick="window.toggleView('signup-view')" class="text-[13px] text-[#0066CC] font-semibold hover:underline">Registrar mi acceso</button>
        </div>
        <footer class="mt-20 text-[9px] text-slate-400 uppercase tracking-[0.4em] font-bold text-center">Â© 2025 IMNUFIT â€¢ Immuno Nutrition & Fitness</footer>
    </section>

    <!-- VISTA 2: SIGNUP (Solo crea la llave de acceso) -->
    <section id="signup-view" class="min-h-screen flex flex-col items-center justify-center p-8 hidden">
        <div class="max-w-[360px] w-full space-y-10 fade-in text-center">
            <div class="space-y-2">
                <h2 class="text-xl font-bold text-slate-800">Activar Acceso</h2>
                <p class="text-[13px] text-slate-500">Usa el mismo correo que diste en consulta.</p>
            </div>
            <form onsubmit="window.handleSignup(event)" class="space-y-4 text-left">
                <input type="email" name="email" placeholder="Correo electrÃ³nico" required class="input-apple">
                <input type="password" name="pass" placeholder="Crear contraseÃ±a" required minlength="6" class="input-apple">
                <button type="submit" class="btn-ingresar mt-4">Crear contraseÃ±a</button>
                <button type="button" onclick="window.toggleView('login-view')" class="w-full text-xs font-bold text-slate-400 uppercase text-center mt-6">Volver</button>
            </form>
        </div>
    </section>

    <!-- VISTA 3: DASHBOARD (Reflejo de Airtable) -->
    <section id="patient-view" class="min-h-screen hidden">
        <header class="bg-white/40 backdrop-blur-xl border-b border-white/60 h-16 flex items-center px-8 justify-between sticky top-0 z-40">
            <img src="https://imnufit.com/wp-content/uploads/2025/05/cropped-logo-y-nombre-AZUL.png" class="h-9">
            <button onclick="window.cerrarSesion()" class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest hover:text-red-500 transition-colors">Salir</button>
        </header>

        <main class="max-w-5xl mx-auto py-12 px-6 space-y-12">
            <!-- Header Saludo (RediseÃ±ado Vertical) -->
            <div class="space-y-6 fade-in">
                <div class="space-y-1">
                    <p id="display-greeting" class="text-[10px] font-bold text-[#2E4982] uppercase tracking-[0.5em]">Bienvenido</p>
                    <h2 class="text-3xl font-bold tracking-tight text-slate-800 leading-tight"><span id="display-nombre">...</span></h2>
                </div>
                
                <!-- Frase BÃ­blica Debajo -->
                <div class="bg-white/60 p-6 rounded-[2rem] border border-white/60 shadow-sm backdrop-blur-md max-w-3xl">
                    <p id="display-frase" class="text-[#2E4982] italic text-[15px] leading-relaxed font-medium">...</p>
                </div>
            </div>

            <!-- Bento Grid: DASHBOARD DE CONSULTAS -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 fade-in" style="animation-delay: 0.1s;">
                
                <!-- Tarjeta 1: PrÃ³xima Cita -->
                <section class="bento-card lg:col-span-2 min-h-[300px] border-emerald-100/30">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-14 h-14 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <span class="text-[9px] font-extrabold bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full uppercase tracking-widest">En Agenda</span>
                    </div>
                    <div>
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1">PrÃ³xima Visita</h4>
                        <p id="display-proxima-cita" class="text-3xl font-bold text-slate-800">Cargando...</p>
                        <p class="text-[14px] text-slate-500 mt-2">Gestionado por tu especialista en Airtable.</p>
                    </div>
                    <div class="mt-8">
                        <a id="btn-calendar-action" target="_blank" class="btn-ghost-sm w-full md:w-auto">Agendar / Modificar</a>
                    </div>
                </section>

                <!-- Tarjeta 2: Historial -->
                <section class="bento-card min-h-[300px] border-blue-100/30">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-1">Expediente</h4>
                        <h3 class="text-2xl font-bold text-slate-800">Mi Progreso</h3>
                        <p class="text-[14px] text-slate-500 mt-2">Resultados y notas clÃ­nicas.</p>
                    </div>
                    <div class="mt-8">
                        <a id="btn-historial-action" target="_blank" class="btn-ghost-sm w-full">Abrir</a>
                    </div>
                </section>

                <!-- Tarjeta 3: Soporte -->
                <section class="bento-card bg-[#2E4982] text-white border-0 shadow-xl shadow-[#2E4982]/10 md:col-span-3">
                    <div class="flex flex-row items-center justify-between gap-6">
                        <div class="flex items-center gap-6">
                            <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold tracking-tight">Â¿Dudas con tu tratamiento?</h3>
                                <p class="text-white/60 text-[12px] font-medium mt-1">Estamos disponibles para asistirte.</p>
                            </div>
                        </div>
                        <a href="https://wa.me/tu_numero" target="_blank" class="hidden md:flex text-[11px] font-bold uppercase tracking-widest text-white/90 hover:text-white items-center gap-2 border border-white/20 px-6 py-3 rounded-full hover:bg-white/10 transition-all">Contactar Soporte â†’</a>
                    </div>
                    <a href="https://wa.me/tu_numero" target="_blank" class="md:hidden mt-6 text-[11px] font-bold uppercase tracking-widest text-white/90 hover:text-white flex items-center justify-center gap-2 border border-white/20 px-6 py-3 rounded-full">Contactar â†’</a>
                </section>
            </div>

            <footer class="pt-10 border-t border-slate-200 text-center">
                <p class="text-[9px] text-slate-400 uppercase tracking-[0.4em] font-bold">IMNUFIT â€¢ powered by Airtable</p>
            </footer>
        </main>
    </section>

</body>
</html>
